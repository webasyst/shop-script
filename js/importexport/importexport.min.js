$.extend($.importexport=$.importexport||{},$.importexport={options:{loading:'<i class="icon16 loading"></i>',path:"#/",plugin_names:{},plugin_profiles:{},title_suffix:"",backend_url:"/webasyst/"},hash:null,path:{plugin:null,module:null,direction:null,profile:null,prefix:null,action:"default",tail:null,dispatch:null},plugins:{},ready:!1,$menu:null,$content:null,$header:null,$profile:null,init:function(a){this.options=$.extend(this.options,a||{});if(!this.ready){this.ready=!0;this.$menu=$("#s-importexport-menu");
this.$header=$("#s-importexport-header");this.$profile=$("#s-importexport-profile");$.ajaxSetup({cache:!1});"undefined"!=typeof $.History&&$.History.bind(function(){$.importexport.dispatch()});$.wa.errorHandler=function(a){if(403===a.status||404===a.status){var a=$(a.responseText),b=$('<div class="block double-padded"></div>');a.find(".dialog-content").length?b.append(a.find(".dialog-content *")):b.append(a.find(":not(style)"));$("#s-importexport-content").empty().append(b).append('<div class="clear-both"></div>');
return!1}return!0};var b=this;this.$profile.on("click","a.js-action",function(){return b.click($(this))});a=window.location.hash;"#/"===a||!a?this.dispatch():$.wa.setHash(a)}},parsePath:function(a){var a=(a||"").replace(/^.*#\//,""),a={plugin:a.replace(/\/.*$/,"")||"",module:"backend",prefix:null,direction:null,profile:null,action:a.replace(/^[^\/]+\//,"").replace(/\/.*$/,"")||"",tail:a.replace(/^([^\/]+\/){1,2}/,"").replace(/\/$/,""),raw:a},b=a.plugin.split(":");1<b.length&&(""+b[b.length-1]).match(/^-?\d*$/)&&
(a.profile=parseInt(b.pop()));1<b.length?(a.plugin=null,a.module=b[0],a.prefix=b[1],a.direction=b[2]?b[2]:null):($.shop.trace("plugin",[b.length,b[0]]),a.plugin=b[0]);$.shop.trace("$.importexport.parsePath",a);return a},dispatch:function(a,b){void 0===a&&(a=window.location.hash);if(!a){var d=this.$menu.find("li:first > a:first");d.length&&(window.location.hash=a=d.attr("href"))}"function"==typeof $("").fileupload&&(this.hash&&this.hash!=a&&("#/images:product/"==a||"#/csv:product/"==a))&&location.reload(!0);
this.hash=a;b&&(window.location.hash=a);var c=this.parsePath(a.replace(/^[^#]*#\/*/,""));this.path.dispatch=c;c.plugin?b=b||c.plugin!=this.path.plugin||c.profile!=this.path.profile&&0<c.profile:c.module&&"backend"!=c.module&&(b=b||c.plugin+c.module!=this.path.plugin+this.path.module||c.direction!=this.path.direction||c.profile!=this.path.profile&&0<c.profile);if(b)if(d=(c.plugin?[c.plugin,c.prefix,c.direction]:[c.module,c.prefix,c.direction]).filter(function(a){return a&&a.length>0}).join(":"),!c.profile&&
this.options.plugin_profiles[d]&&"hash"==c.action&&c.tail)this.profileAdd(d,c.action+"/"+c.tail);else{var e=$("#s-importexport-content");if(c.plugin!=this.path.plugin||c.module!=this.path.module||c.direction!=this.path.direction)this.$header.hide(),this.$profile.hide();this.importexportBlur(this.path.plugin,d);$.shop&&$.shop.trace("$.importexport.dispatch (default) "+this.path.plugin+" -> "+c.plugin);this.path.tail=null;b||e.empty().html(this.options.loading);var g=this;e.load(this.helper.buildUrl(c),
function(){e.find(">div.block.double-padded").length||e.wrapInner('<div class="block double-padded"></div>');g.importexportLoad(e,c)})}else c.plugin&&this.importexportAction(c.action,c.tail)},click:function(a){try{var b=a.attr("href").replace(/.*#\/?/,"").replace(/\/$/,"").split("/"),d=b.shift(),c;scope=this;if((c=d.match(/^(\w+(:\w+)?)(:\d+)?$/))&&this.plugins[c[1]])scope=this.plugins[c[1]],d=null;var e=$.shop.getMethod(b,scope,d);if(e.name){if($.shop.trace("$.importexport.click",e),!a.hasClass("js-confirm")||
confirm(a.data("confirm-text")||a.attr("title")||"Are you sure?"))e.params.push(a),scope[e.name].apply(scope,e.params)}else $.shop.error("Not found js handler for link",[e,b,a])}catch(g){$.shop.error("Exception "+g.message,g)}return!1},profileAdd:function(a){$.ajax({url:"?module=importexport&action=add",type:"POST",dataType:"json",data:{plugin:a},success:function(b){$.shop.trace("addAction",b.data);b&&"ok"==b.status&&(window.location.hash=window.location.hash.replace(RegExp("\\/("+a+"):?\\d*\\/",
"g"),"/$1:"+b.data+"/"))}})},profileUpdateName:function(a){var b=(""+this.profiles.key()+":"+this.path.profile).replace(/([:#])/g,"\\\\$1");$("#s-importexport-profile").find('a[href="#/'+b+'/"]:first').text(a)},profileDelete:function(a,b){var d=this.path.profile,c=(""+a+":"+d).replace(/([:#])/g,"\\\\$1");$.shop.trace("profileDelete",[a,d,c]);var e=$("#s-importexport-profile").find('a[href^="#/'+c+'/"]:first').parents("li:first"),g=b.find("i.icon16.delete");g.removeClass("delete").addClass("loading");
var f=this;$.ajax({url:"?module=importexport&action=delete",type:"POST",dataType:"json",data:{plugin:a,profile:d},success:function(c){$.shop.trace("profileDelete",c.data);if(c&&"ok"==c.status&&(g.removeClass("loading").addClass("delete"),b.parents("li:first").hide(),e.remove(),$.shop.trace("profileDelete",[f.path,d]),f.profiles.list[a][d]&&(f.profiles.list[a][d]=null),f.path.profile==d)){c=null;for(d in f.profiles.list[a])if(f.profiles.list[a].hasOwnProperty(d)&&f.profiles.list[a][d]){c=d;break}c?
window.location.hash=window.location.hash.replace(/:\d*\/$/,":"+c+"/"):f.profileAdd(a)}}})},importexportOptions:function(a){var b=this.path.dispatch.plugin||this.path.plugin;$.shop&&$.shop.trace("$.importexport.importexportOptions",b);"undefined"==typeof this[b+"_options"]&&(this[b+"_options"]={});a&&(this[b+"_options"]=$.extend(this[b+"_options"],a))},importexportBlur:function(a){this.$menu.find("li.selected").removeClass("selected");$.shop&&$.shop.trace("$.importexport.importexportBlur",a);(this.path.plugin||
this.path.module)&&this.call("Blur",[]);$("#s-importexport-content").html(this.options.loading)},importexportLoad:function(a,b){this.path.plugin=b.plugin;this.path.module=b.module;this.path.direction=b.direction;this.path.prefix=b.prefix;this.path.profile=b.profile;this.path.tail=b.tail;$.shop.trace("$.importexport.importexportLoad",b);this.$menu.find("li.selected").removeClass("selected");var d=this.path.plugin?this.path.plugin:this.path.module+":"+this.path.prefix+(this.path.direction?":"+this.path.direction:
""),c=d;this.path.direction&&this.path.plugin&&(c+=":"+this.path.direction);c=this.options.plugin_profiles[d]?c+":":c+"/";d=this.$menu.find('a[href^="#/'+c+'"]');d.parents("li").addClass("selected");d=a.find("h1:first").hide().text()||this.options.plugin_names[this.path.plugin]||d.clone().children().remove().end().text()||"";window.document.title=d+this.options.title_suffix;this.$header.find("> h1:first").text(d);this.$header.find("> p:first").html(a.find("p:first").hide().html());this.$header.show();
this.profiles.init();this.profiles.draw(b);this.$content=a;var e=this;this.products.init(this.$content.find("form"));this.$content.on("click","a.js-action",function(){try{return e.click($(this))}catch(a){return $.shop.error("Exception "+a.message,a),!1}});this.importexportProfileInit();this.onPluginLoad(b,function(){e.call("onInit",[b]);e.importexportAction(b.action,b.tail)},200)},importexportProfileInit:function(){var a=this;this.$content.find("form").bind("submit.profile",function(){if(null!=a.path.profile)try{a.profiles.onSubmit();
var b=$(this);a.profileUpdateName(b.find(':input[name="profile\\[name\\]"]:first').val());b.find(".js-profile-notice").hide()}catch(d){$.shop.error("Exception "+d.message,d)}return!0});this.$content.off("click.profile").on("click.profile","h2.js-profile-collapsible",function(){var a=$(this),d=a.parents("div.field-group:first");a.data("visible")?d.find("> div.field:visible").slideUp():d.find("> div.field:hidden").slideDown();a.data("visible",!a.data("visible"));return!1})},importexportAction:function(a,
b){var d="";a&&(d+=a.substr(0,1).toUpperCase()+a.substr(1));d+="Action";$.shop&&$.shop.trace("$.importexport.importexportAction",[a,b]);this.call(d,[b]);this.path.tail=b},onPluginLoad:function(a,b,d){var d=d?d+50:50,c=!1;(c=a.plugin?!!this.plugins[a.plugin]:!!this[a.module+"_"+a.prefix])?b():setTimeout(function(){$.importexport.onPluginLoad(a,b,d)},d)},call:function(a,b){var d;d=this.path.plugin?this.path.plugin:this.path.module+"_"+this.path.prefix;var c=d+a.substr(0,1).toUpperCase()+a.substr(1),
c=c.replace(/^(\d)/,"a$1"),e="function"==typeof this[c],g=$.shop&&$.shop.trace("$.importexport.call "+c,[e,typeof this[c],b]),f=null;if(e){try{f=this[c].apply(this,b)}catch(h){($.shop&&$.shop.error||console.log)("Exception at $.importexport."+c+": "+h.message,h)}$.shop&&$.shop.trace("$.settings.call complete "+c,[$.shop.time.interval(g)+"s",f,b])}else if(c=a.substr(0,1).toLowerCase()+a.substr(1),c=c.replace(/^(\d)/,"a$1"),e=this.plugins[d]&&"function"==typeof this.plugins[d][c],g=$.shop&&$.shop.trace("$.importexport.call "+
d+"."+c,[e,b,d]),e){try{f=this.plugins[d][c].apply(this.plugins[d],b)}catch(i){($.shop&&$.shop.error||console.log)("Exception at $.importexport."+c+": "+i.message,i)}$.shop&&$.shop.trace("$.settings.call complete "+d+"."+c,[$.shop.time.interval(g)+"s",f,b])}else $.shop.error("method not found at call",[a,c]);return f},profiles:{list:{},$profiles:null,$container:null,path:{},sortable:!1,counter:0,init:function(){this.$profiles=$("#s-importexport-profile");this.$container=$("#s-importexport-content");
var a=this;this.sortable&&this.$profiles.sortable({distance:5,opacity:0.75,items:"> li:not(.no-tab)",axis:"x",forceHelperSize:!0,containment:"parent",update:function(b,d){var c=parseInt($(d.item).data("id")),e=$(d.item).prev().data("id"),e=void 0===e?0:parseInt(e);a.onSort(c,e,$(this))}})},onSubmit:function(){this.$profiles.find("> li.no-tab:last").hide()},onSort:function(a,b,d){$.shop.trace("$.importexport.profiles.onSort",[a,b,d])},set:function(a,b){this.list[a]=b||{}},onRun:function(){this.sortable&&
this.$profiles.sortable("disable")},onComplete:function(){this.sortable&&this.$profiles.sortable("enable")},draw:function(a){this.path=a||this.path;var b,d=0;this.$profiles.find("> li:not(.no-tab)").remove();this.$profiles.find("> li.no-tab").show();var c=this.key();$.shop.trace("profiles.draw",[c,$.importexport.options.plugin_profiles[c]]);if($.importexport.options.plugin_profiles[c]){var e=this.$profiles.find("> li.no-tab:first > a:first");e.attr("href",e.data("href").replace(/%plugin%/,c));e=null;
if(this.list[c]){var g=this.$profiles.find("> li.no-tab:first");for(b in this.list[c])this.list[c].hasOwnProperty(b)&&(g.before(this.html(b,c)),b==a.profile&&(e=b),++d)}if(d){if(a=this.$profiles.find("> li.no-tab:last").show().find("> a:first"),a.attr("href",a.data("href").replace(/%plugin%/,c)),a.find("i.icon16.loading").removeClass("loading").addClass("delete"),this.show(),!e&&b&&(window.location.hash=window.location.hash.replace(/:\d*\/$/,":"+b+"/")),this.sortable){var f=this;setTimeout(function(){f.$profiles.sortable("refresh");
f.$profiles.sortable("enable")},50)}}else this.hide(),$.importexport.profileAdd(c)}else this.hide()},key:function(){return this.path.plugin?this.path.plugin:[this.path.module,this.path.prefix,this.path.direction].filter(function(a){return a&&0<a.length}).join(":")},show:function(){this.$profiles.show();this.$container.addClass("tab-content")},hide:function(){this.$profiles.hide();this.$container.removeClass("tab-content")},form:function(a){return'<div class="field"'+(a?' style="display:none;"':"")+
'><div class="name">'+$_("Profile name")+'</div><div class="value"><input type="text" name="profile[name]"></div></div>'},html:function(a,b){var d,c;0<a&&(c=this.list[b][a]);d=$("<a></a>");c?(d.text(c.name),d.attr("title",c.description)):d.text($_("New importexport profile"));d.attr("href",["#",this.key()+":"+(a||--this.counter)].join("/")+"/");c=$("<li></li>");c.append(d);(!a||a==this.path.profile)&&c.addClass("selected");return c}},products:{$context:null,$inputs:null,init:function(a){this.$context=
a;this.$inputs=this.$context.find(':input[name="hash"]');var b=this;this.$inputs.change(function(){b.handler($(this))});this.$inputs.trigger("change")},action:function(a){var b=(a||"").split("/"),a=this.$inputs.filter('[value="'+b[0]+'"]:first');if(a.length){var d=b[0]||"";a.parents("li").show();$.shop.trace("hash/action/test",[d,b]);switch(d){case "id":d=b[1]||"0";this.$context.find(':input[name="product_ids"]:first').val(d);b=a.parents("li").find("span");b.text(b.text().replace(/%d/g,d.split(",").length));
break;case "type":b=parseInt(b[1]);this.$context.find(':input[name="type_id"]').val([b]);break;case "set":b=b[1];this.$context.find(':input[name="set_id"]').val([b]);break;case "category":d=b[1]||"0",this.$context.find(':input[name="category_ids"]:first').val(d),b=a.parents("li").find("span"),b.text(b.text().replace(/%d/g,d.split(",").length))}a.attr("checked",!0).trigger("change")}},handler:function(a){var b=a.parents("div.field");a.is(":checked")&&(b.find(".js-hash-values:visible").hide(),b.find(".js-hash-values.js-hash-"+
a.val()).show())}},helper:{buildUrl:function(a){var b=[];if(a.plugin){if("plugins"==a.plugin)return $.importexport.options.backend_url+"installer/?module=plugins&action=view&slug=shop&filter[tag]=importexport";b.push("plugin="+a.plugin)}a.module&&"backend"!=a.module&&b.push("module="+a.module);b.push("action="+(a.prefix||"")+"setup");a.direction&&b.push("direction="+a.direction);a.profile&&b.push("profile="+a.profile);return"?"+b.join("&")}},getPlugin:function(){}});
