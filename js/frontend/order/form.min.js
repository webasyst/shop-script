!function(e){"use strict";function r(){return e(document).width()<=760}var t=function(e){return t=function(e){var r=this;r.$wrapper=e.$wrapper,r.$form=r.$wrapper.find("form:first"),r.templates=e.templates,r.errors=e.errors,r.scope=e.scope,r.contact_id=e.contact_id,r.reload=!0,r.initClass()},t.prototype.initClass=function(){var r=this;"object"==typeof r.errors&&Object.keys(r.errors).length&&(r.scope.DEBUG("Errors:","error",r.errors),r.renderErrors(r.errors)),r.$form.on("submit",function(e){e.preventDefault()}),r.$wrapper.on("focus","select, textarea, input",function(r){var t=e(this);t.hasClass("wa-error")&&t.data("reload",!0)}),r.$wrapper.on("change","select, textarea, input",function(t){var a=e(this),n=!!a.data("affects-rate")||!!a.data("reload"),o=a.closest(".wa-field-wrapper");o.length||(o=a.parent()),r.scope.validate(o,!0).length||n&&r.update({reload:!0})}),r.initType(),r.initAuth(),r.initDatepicker()},t.prototype.initAuth=function(){function r(){e.contains(document,n.$wrapper[0])?i&&i.close():o.off("wa_auth_contact_logged",r)}function t(r,t){r.on("click","a",function(r){var t=e(this),n=t.data("type"),o=["login","signup","forgotpassword","setpassword"];n&&(r.preventDefault(),o.indexOf(n)>=0&&a(n))}),r.on("wa_auth_set_password",function(e,r){a("setpassword",{data:[{name:"hash",value:r}]})}),r.on("wa_auth_resent_password",function(e,r){a("login")}),r.on("wa_auth_contact_signed",function(e,r,t){t.password_sent&&a("login")}),r.on("wa_auth_form_change_view",function(){t.resize()})}function a(r,a){a=a||{};var o=n.scope.urls.auth_dialog,l=[{name:"type",value:r}],c=n.$wrapper.find(".js-type-field");if(c.length){var p=e.trim(c.val());p&&l.push({name:"contact_type",value:p})}return a.data&&(l=l.concat(a.data)),s&&s.abort(),i&&i.lock(!0),s=e.post(o,l,function(r){i&&i.close(),i=new window.waOrder.ui.Dialog({$wrapper:e(r),onOpen:t})}).always(function(){s=null})}var n=this,o=e(document),i=null,s=null;o.on("wa_auth_contact_logged",r),n.contact_id?n.$wrapper.on("click",".js-logout-button",function(r){e(document).trigger("wa_order_reload_start")}):n.$wrapper.on("click",".js-show-login-dialog",function(e){e.preventDefault(),a("login")})},t.prototype.initType=function(){var r=this,t=r.$wrapper.find(".js-type-toggle").first(),a=r.$wrapper.find(".js-type-field");new window.waOrder.ui.Toggle({$wrapper:t,change:function(t,n,o){var i=e(n).data("id");i&&(r.reload=!0,a.val(i),r.scope.update())}})},t.prototype.initDatepicker=function(){this.$wrapper.find(".js-datepicker").each(function(){var r=e(this),t={},a=r.data("alt");if(a){var n=r.closest(".wa-field-wrapper").find(a);n.length&&(t.altField=n,t.altFormat="yy-mm-dd")}r.datepicker(t),r.on("keydown keypress keyup",function(e){13===e.which&&e.preventDefault()})})},t.prototype.getData=function(e){var r=this,t=[];if(e.clean)t.push({name:"auth[html]",value:1});else{var a=!1!==e.render_errors;r.$form.length&&(t=r.$form.serializeArray()),!e.only_api&&r.reload&&t.push({name:"auth[html]",value:1});var n=r.scope.validate(r.$form,a);n.length&&(t.errors=n)}return t},t.prototype.render=function(e){var r=this,t=!1;return e.auth&&e.auth.html&&(r.$wrapper.replaceWith(e.auth.html),t=!0),t},t.prototype.renderErrors=function(r){function t(r){function t(){o.removeClass(n),a.remove(),o.off("change",t)}var a=e('<div class="wa-error-text" />').text(r.text),n="wa-error";if(r.$field){var o=r.$field;if(!o.hasClass(n)){o.addClass(n);var i=o.closest(".wa-field-wrapper");i.length?i.append(a):a.insertAfter(o),o.on("change keyup",t)}}}var a=this,n=[];return e.each(r,function(e,r){if(r.name&&r.text){var o=a.$wrapper.find('[name="'+r.name+'"]');o.length&&(r.$field=o,t(r))}n.push(r)}),n},t.prototype.update=function(e){var r=this;return e.reload&&(r.reload=!0),r.scope.update().always(function(){r.reload=!0})},t}(e),a=function(e){return a=function(e){var r=this;r.$wrapper=e.$wrapper,r.$form=r.$wrapper.find("form:first"),r.disabled=e.disabled,r.errors=e.errors,r.scope=e.scope,r.reload=!0,r.initClass()},a.prototype.initClass=function(){function r(r,t){i(r)&&(r.on("keydown",function(){a(r)}),r.on("change",function(){t&&t.length&&e.each(t,function(e,r){r.length&&r.attr("disabled",!0)}),n(r)}),r.on("focus",function(){p&&r.trigger("blur")}))}function t(e,t){if(i(e)){if(!i(t))return r(e),!1;e.on("keydown",function(r){13===r.keyCode&&(n(e),e.trigger("blur"))}),e.on("focus",function(){clearTimeout(l),p&&e.trigger("blur")})}}function a(e){clearTimeout(l),l=setTimeout(function(){e.trigger("change")},c)}function n(r){if(clearTimeout(l),!e.trim(r.val()).length)return!1;s.scope.trigger("region_change"),p=!0}function o(r){function t(){clearTimeout(w),u||(w=setTimeout(function(){o(!0)},c))}function a(){function t(r){var t=[];return e.each(r,function(e,r){var a=r.city;a&&t.push({label:a,value:a})}),t}var a=e.Deferred(),n=s.scope.urls.order+"addressAutocomplete/",o={};if(d.length){var i=d.val();i&&(o.country=i)}if(f.length){var l=f.val();l&&(o.region=l)}var c=r.val();if(c&&(o.city=c),v.length){var p=v.val();p&&(o.zip=p)}return h&&h.abort(),h=e.post(n,o,"json").always(function(){h=null}).done(function(e){if("ok"===e.status){var r=e.data.result;r=r.length?t(r):[],a.resolve(r)}else a.reject()}).fail(function(){a.reject()}),a.promise()}function o(e){var t=e?0:100;r.trigger("blur"),clearTimeout(m),u||function(){m=setTimeout(function(){n(r)},t)}()}var u=i(v),h=null,m=0,w=0;r.autocomplete({source:function(e,r){a().then(function(e){r(e),e.length||t()})},minLength:2,focus:function(){return!1},select:function(e,t){return r.val(t.item.value),o(!0),!1}}),r.on("change",function(){o()}),r.on("keydown",function(e){clearTimeout(w),13===e.keyCode&&(n(r),r.trigger("blur"))}),r.on("focus",function(){clearTimeout(l),p&&r.trigger("blur")})}function i(e){return!(!e.length||!e.is(":visible"))}var s=this,l=0,c=1e4,p=!1;"object"==typeof s.errors&&Object.keys(s.errors).length&&s.scope.DEBUG("Errors:","error",s.errors),s.$form.on("submit",function(e){e.preventDefault()});var u=s.$form.find(".js-location-field"),d=s.$form.find(".js-country-field"),f=s.$form.find(".js-region-field"),h=s.$form.find(".js-city-field"),v=s.$form.find(".js-zip-field");r(u,[d,f,h,v]),r(d,[f,h,v]),r(f,[h,v]),t(v,h),function(r){var t=[],a=!1;e.each(r,function(r,n){if(n.length&&n.is(":visible"))if(a)t.push(n);else{var o=e.trim(n.val());o&&(a=!0)}}),t.length&&e.each(t,function(e,r){var t=r.closest(".wa-field-wrapper");s.scope.validate(t,!0)})}([v,h,f,d,u]),h.length&&h.hasClass("js-city-autocomplete")?setTimeout(function(){o(h)},100):t(h,v)},a.prototype.getData=function(e){var r=this,t=[];if(r.disabled)t.push({name:"region[html]",value:"only"});else if(e.clean)t.push({name:"region[html]",value:"only"});else{var a=!1!==e.render_errors;r.$form.length&&(t=r.$form.serializeArray()),!e.only_api&&r.reload&&t.push({name:"region[html]",value:"only"});var n=r.scope.validate(r.$form,a);n.length&&(t.errors=n)}return t},a.prototype.render=function(e){var r=this,t=!1;return e.region&&e.region.html&&(r.$wrapper.replaceWith(e.region.html),t=!0),t},a.prototype.renderErrors=function(r){var t=[];return e.each(r,function(e,r){t.push(r)}),t},a.prototype.update=function(e){var r=this;r.reload=!!e.reload,r.scope.update().always(function(){r.reload=!0})},a}(e),n=function(e){function t(r,t){var a={};return t&&e.each(r,function(e,r){r[t]&&(a[r[t]]=r)}),a}var a=function(e){return a=function(r){var t=this;t.$wrapper=r.$wrapper,t.$sidebar=t.$wrapper.find(".wa-sidebar-section"),t.$map_section=t.$wrapper.find(".wa-map-section"),t.$variants=t.$wrapper.find(".wa-variant-wrapper"),t.dialog=r.dialog,t.scope=r.scope,t.show_map=r.show_map,t.templates=r.templates,t.variants=function(r){return e.each(r,function(e,r){var t=r.lat?parseFloat(r.lat):null,a=r.lng?parseFloat(r.lng):null;t=isNaN(t)?null:t,a=isNaN(a)?null:a,r.lat=t,r.lng=a}),r}(r.variants),t.active_variant=r.active_variant,t.onSet="function"==typeof r.set?r.set:function(){},t.map_deferred=e.Deferred(),t.getMap=function(){return t.map_deferred.promise()},t.initClass()},a.prototype.initClass=function(){var e=this;e.show_map?e.initMap():e.$map_section.hide(),e.initFilters(),e.initDetails(),e.initMobileToggle()},a.prototype.initMap=function(){function t(t){function a(e){var r=null,a=null;if(!e.lat||!e.lng)return!1;r=e.lat,a=e.lng;var n=new t.Placemark([r,a],{balloonContentBody:e.name});return n.variant_id=e.variant_id,i[e.variant_id]=n,n}var i={},s=null,l=n(o.variants),c=new t.Map("wa-shipping-map",{center:l,zoom:10,controls:["fullscreenControl","zoomControl","geolocationControl"]}),p=new t.Clusterer,u=function(e){r()||c.setCenter(e.geometry.getCoordinates(),17).then(function(){s=e.balloon;var r=p.getObjectState(e);!r.isClustered&&r.isShown&&(s.isOpen()||s.open())})};!function(){function r(){var e=c.controls.get("fullscreenControl");e.state.get("fullscreen")&&e.exitFullscreen()}var t=[];if(e.each(o.variants,function(e,r){var n=a(r);n&&t.push(n)}),p.add(t),c.geoObjects.add(p),p.events.add("click",function(t){var a=t.get("target");if(a.getGeoObjects){var n=a.getGeoObjects();if(c.getZoom()>=17){var i=[];e.each(n,function(e,r){r.variant_id&&i.push(r.variant_id)}),i.length&&(r(),o.$wrapper.trigger("show_variant_details",[i,null]))}}else a.variant_id&&(r(),o.$wrapper.trigger("show_variant_details",[[a.variant_id],null]))}),o.active_variant&&i[o.active_variant]){var n=i[o.active_variant];u(n)}}(),function(){var e=new t.control.SearchControl({options:{noPlacemark:!0}}),r=new t.Collection(null,{});c.controls.add(e),c.geoObjects.add(r),e.events.add("resultselect",function(t){var a=t.get("index");e.getResult(a).then(function(e){e.options.set("preset","islands#redIcon"),r.add(e)})}).add("submit",function(){r.removeAll()})}(),o.map_deferred.resolve({map:c,placemarks:i,refresh:function(r){var t=[];e.each(r,function(e,r){r&&i[r]&&t.push(i[r])}),p.removeAll(),p.add(t)},reset:function(){c.setCenter(l,10),s&&(s.isOpen()&&s.close(),s=null)},moveTo:function(e){return u(e)}})}function a(){function t(e){if(!r()){var t=o.variants[e.variant_id];c.setZoom(17),c.setCenter(e.getPosition()),u.close(),u.setContent(t.name),u.open(c,e)}}function a(r){return d&&d.clearMarkers(),d=new MarkerClusterer(c,r,{maxZoom:18,imagePath:"//developers.google.com/maps/documentation/javascript/examples/markerclusterer/m"}),d.addListener("clusterclick",function(r){if(c.getZoom()>=17){var t=r.getMarkers(),a=[];e.each(t,function(e,r){a.push(r.variant_id)}),a.length&&(i(),o.$wrapper.trigger("show_variant_details",[a,null]))}}),d}function i(){try{document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen()}catch(e){}}var s={},l=n(o.variants),c=new google.maps.Map(document.getElementById("wa-shipping-map"),{center:{lat:l[0],lng:l[1]},zoom:10,maxZoom:18}),p=function(){function r(e){var r=null,t=null;if(!e.lat||!e.lng)return!1;r=parseFloat(e.lat),t=parseFloat(e.lng);var a=new google.maps.Marker({position:{lat:r,lng:t},title:e.name});return a.variant_id=e.variant_id,s[e.variant_id]=a,a.addListener("click",function(){c.setZoom(17),c.setCenter(a.getPosition()),u.close(),u.setContent(e.name),u.open(c,a),i(),o.$wrapper.trigger("show_variant_details",[[e.variant_id],null])}),a}var t=[];return e.each(o.variants,function(e,a){var n=r(a);n&&t.push(n)}),t}(),u=new google.maps.InfoWindow,d=a(p);if(o.active_variant&&s[o.active_variant]){var f=s[o.active_variant];setTimeout(function(){t(f)},1e3)}o.map_deferred.resolve({map:c,placemarks:s,refresh:function(r){var t=[];e.each(r,function(e,r){r&&s[r]&&t.push(s[r])}),d=a(t)},reset:function(){c.setCenter(l),c.setZoom(10),u.close()},moveTo:function(e){return t(e)}})}function n(r){var t=[55,37],a=[],n=[];if(e.each(r,function(e,r){r.lat&&r.lng&&(a.push(r.lat),n.push(r.lng))}),a.length&&n.length){var o=Math.min.apply(null,a),i=Math.max.apply(null,a),s=Math.min.apply(null,n),l=Math.max.apply(null,n);t[0]=o+(i-o)/2,t[1]=s+(l-s)/2}return t}var o=this;return!(!o.scope.map.adapter||!o.scope.map.api_uri)&&(!!e("#wa-shipping-map").length&&void("yandex"===o.scope.map.adapter?window.waOrder.ui.load([{id:"yandex-maps-api-js",type:"js",uri:o.scope.map.api_uri}]).then(function(){if(!window.ymaps)return o.scope.scope.DEBUG("Yandex API required","error"),!1;window.ymaps.ready(function(){t(window.ymaps)})}):"google"===o.scope.map.adapter&&window.waOrder.ui.load([{id:"google-maps-api-js",type:"js",uri:o.scope.map.api_uri},{id:"google-maps-clusterer-js",type:"js",uri:"//developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"}]).then(function(){a()})))},a.prototype.initFilters=function(){function r(e){var r=e.data("id"),t=n.indexOf(r);e.hasClass("is-active")?(e.removeClass("is-active"),t>=0&&n.splice(t,1)):(e.addClass("is-active"),t>=0||n.push(r)),n.length?o.addClass(i):o.removeClass(i)}function t(){var r=[];a.$variants.each(function(){var t=e(this),a=t.data("id"),o=t.data("service-id");!n.length||n.indexOf(o)>=0?(t.show(),r.push(a)):t.hide()}),a.getMap().then(function(e){e.refresh(r)})}var a=this,n=[],o=a.$wrapper.find(".wa-filters-list"),i="is-set";a.$wrapper.on("click",".js-set-filter",function(a){a.preventDefault(),r(e(this)),t()})},a.prototype.initDetails=function(){function t(e){e?(o.onSet(e),o.dialog.close()):o.scope.scope.DEBUG("Variant id is missing.","error")}function a(r){if(r){var t="";e.each(r,function(e,r){o.variants[r]?t+=n(o.variants[r]):o.scope.scope.DEBUG("Variant data is missing.","error")}),l.html(t),i.hide(),s.addClass("is-shown"),1===r.length&&o.getMap().then(function(e){if(e.placemarks&&e.placemarks[r[0]]){var t=e.placemarks[r[0]];e.moveTo(t)}})}else s.removeClass("is-shown"),l.html(""),i.show(),o.dialog.resize()}function n(e){var r=o.templates.map_details;r=r.replace("%title%",e.name).replace("%variant_id%",e.variant_id);var t="";if(o.show_map||("yandex"===o.scope.map.adapter?t="ymaps-geolink":"google"===o.scope.map.adapter&&(t="google-geolink")),r=r.replace("%geolink%",t),r=e.formatted_price?r.replace("%shipping_cost_style%","").replace("%shipping_cost%",e.formatted_price):r.replace("%shipping_cost_style%","display: none;"),r=e.formatted_date?r.replace("%shipping_time_style%","").replace("%shipping_time%",e.formatted_date):r.replace("%shipping_time_style%","display: none;"),r=e.service?r.replace("%shipping_service_style%","").replace("%shipping_service%",e.service):r.replace("%shipping_service_style%","display: none;"),r=e.storage_days?r.replace("%storage_time_style%","").replace("%storage_time%",e.storage_days):r.replace("%storage_time_style%","display: none;"),e.description){var a=e.description;if(!o.show_map&&"google"===o.scope.map.adapter){a=('<a class="google-geolink" target="_blank" href="//maps.google.com/maps?q=%encode_address%">'+e.description+"</a>").replace("%encode_address%",encodeURIComponent(e.description))}r=r.replace("%address_style%","").replace("%address%",a)}else r=r.replace("%address_style%","display: none;");return r}var o=this,i=o.$sidebar.find(".wa-variants-section"),s=o.$sidebar.find(".wa-variant-details-section"),l=s.find("> .wa-section-body");o.$wrapper.on("click",".js-show-variant-details",function(n){n.preventDefault();var o=e(this).data("id");r()?t(o):a([o])}),o.$wrapper.on("show_variant_details",function(e,r){a(r)}),o.$wrapper.on("click",".js-show-variants-list",function(e){e.preventDefault(),a(!1)}),o.$wrapper.on("click",".js-use-variant",function(r){r.preventDefault(),t(e(this).data("variant-id"))})},a.prototype.initMobileToggle=function(){var r=this,t=r.$wrapper.find(".js-mobile-view-toggle").first();if(!t.length)return!1;if(r.$wrapper.addClass("is-mobile-list-view"),r.show_map){var a=new window.waOrder.ui.Toggle({$wrapper:t,change:function(t,a,n){var o=e(a).data("id");o&&("map"===o?(r.$wrapper.removeClass("is-mobile-list-view"),r.$wrapper.addClass("is-mobile-map-view")):"list"===o&&(r.$wrapper.removeClass("is-mobile-map-view"),r.$wrapper.addClass("is-mobile-list-view")))}}),n=a.$wrapper.find('[data-id="list"]');n.length&&r.$wrapper.on("show_variant_details",function(e,r){n.trigger("click")})}else t.hide()},a}(jQuery),o=function(e){return o=function(e){var r=this;r.$wrapper=e.$wrapper,r.active_class="is-active",r.onChange="function"==typeof e.onChange?e.onChange:function(){},r.$active=r.$wrapper.find(".wa-type-wrapper."+r.active_class),r.initClass()},o.prototype.initClass=function(){var r=this;r.$wrapper.on("click",".wa-type-wrapper",function(t){t.preventDefault(),r.changeType(e(this))})},o.prototype.changeType=function(e){var r=this;if(e.hasClass(r.active_class))return!1;var t=e.data("id");t&&(r.$active.length&&r.$active.removeClass(r.active_class),r.$active=e.addClass(r.active_class),r.onChange(t))},o}(jQuery);return n=function(e){var r=this;r.$wrapper=e.$wrapper,r.$form=r.$wrapper.find("form:first"),r.map=e.map,r.templates=e.templates,r.disabled=e.disabled,r.variants_count=e.variants_count,r.locales=e.locales,r.errors=e.errors,r.scope=e.scope,r.urls=e.urls,r.reload=!0,r.initClass()},n.prototype.initClass=function(){function t(r,t){function a(e){e?r.lock(!0):r.lock(!1)}var o=n.urls.variants_dialog,i=n.scope.getFormData();a(!0),e.post(o,i).done(function(a){var o=e(a);o.data("scope",n),new n.scope.ui.Dialog({$wrapper:o,options:{dropdown:r,show_map:t}})}).always(function(){a(!1)})}function a(t){var a=r()?55:10,o=t.offset().top;if(e(window).height()>=600)try{o=n.scope.sections.region.$wrapper.offset().top}catch(e){}e("html, body").scrollTop(o-a)}var n=this;"object"==typeof n.errors&&Object.keys(n.errors).length&&n.scope.DEBUG("Errors:","error",n.errors),n.$form.on("submit",function(e){e.preventDefault()});var i=null,s=null,l=n.$wrapper.find("#js-delivery-types-section");l.length&&(i=l.find(".js-type-field"),new o({$wrapper:l,onChange:function(r){i.val(r),n.scope.DEBUG("Delivery type changed â€” "+r,"info"),s&&s.val(""),n.update({reload:!0}).then(function(){var r=e("#js-delivery-variants-section");if(r.length){1!==r.find(".wa-dropdown-item").length&&r.find(".wa-dropdown-toggle").trigger("click")}})}}));var c=n.$wrapper.find("#js-delivery-variants-section");if(c.length){s=c.find(".js-variant-field");var p=i?i.val():"",u=new window.waOrder.ui.Dropdown({$wrapper:c.find(".js-variants-select"),hover:!1,change_title:!1,change_selector:".wa-dropdown-item",open:function(e){var o=r(),i=n.variants_count;return"always"===n.map.display?(t(e,!0),!1):"desktop"===n.map.display?(t(e,!o),!1):i>5&&"pickup"===p?(t(e,!1),!1):void a(c)},change:function(r,t,a){var o=e(t),i=o.data("id"),l=o.find(".wa-name").data("name");s.val(i),a.setTitle(l),n.update({reload:!0})}});l.on("click",".wa-type-wrapper.is-active",function(){u.$button.trigger("click")})}var d=n.$wrapper.find("#js-delivery-short-variants-section");d.length&&(i=l.find(".js-type-field"),s=d.find(".js-variant-field"),new window.waOrder.ui.Dropdown({$wrapper:d.find(".js-variants-select"),hover:!1,change_title:!1,change_selector:".wa-dropdown-item",open:function(e){a(d)},change:function(r,t,a){var o=e(t),l=o.data("type-id"),c=o.data("variant-id"),p=o.find(".wa-name").data("name");i.val(l),s.val(c),a.setTitle(p),n.update({reload:!0})}}))},n.prototype.initPickupDialog=function(e){var r=this,n=e.$wrapper,o=e.variants,i=e.active_variant,s=t(o,"variant_id"),l=e.templates,c=n.data("dialog"),p=c.options.show_map,u=c.options.dropdown,d=new a({$wrapper:n,dialog:c,variants:s,active_variant:i,scope:r,templates:l,show_map:p,set:function(e){if(s[e]){var t=s[e],a='<div class="wa-dropdown-item js-set-dropdown-item" data-id="%variant_id%"><div class="wa-delivery-variant"><div class="wa-name" data-name="%variant_name%"></div></div></div>';a=a.replace("%variant_id%",e).replace("%variant_name%",t.name),u.$menu.append(a);u.$menu.find('.js-set-dropdown-item[data-id="'+e+'"]').trigger("click")}else r.scope.DEBUG("Variants is missing","error",e)}});r.scope.DEBUG("Pickup Dialog initialized","info",d)},n.prototype.getData=function(r){var t=this,a=[];if(t.disabled)a.push({name:"shipping[html]",value:"only"});else if(r.clean)a.push({name:"shipping[html]",value:"only"});else{var n=!1!==r.render_errors;t.$form.length&&(a=t.$form.serializeArray()),!r.only_api&&t.reload&&a.push({name:"shipping[html]",value:"only"});var o=t.scope.validate(t.$form),i=t.$wrapper.find("#js-delivery-types-section");if(i.length){var s=i.find(".wa-types-list"),l=i.find(".js-type-field"),c=e.trim(l.val());if(!c.length&&(o.push({$wrapper:s,id:"type_required",value:t.locales.type_required}),n&&!s.hasClass("wa-error"))){var p=e('<div class="wa-error-text" />').text(t.locales.type_required).insertAfter(s);s.addClass("wa-error").one("change",function(){s.removeClass("wa-error"),p.remove()})}}var u=null,d=t.$wrapper.find("#js-delivery-variants-section");if(d.length){var f=d.find(".js-variants-select"),h=d.find(".js-variant-field");if(u=e.trim(h.val()),!u.length&&(o.push({$wrapper:f,id:"variant_required",value:t.locales.variant_required}),n&&!f.hasClass("wa-error"))){var v=e('<div class="wa-error-text" />').text(t.locales.variant_required).insertAfter(f);f.addClass("wa-error").one("change",function(){f.removeClass("wa-error"),v.remove()})}}var m=t.$wrapper.find("#js-delivery-short-variants-section");if(m.length){var w=m.find(".js-variants-select"),g=m.find(".js-variant-field");if(u=e.trim(g.val()),!u.length&&(o.push({$wrapper:w,id:"variant_required",value:t.locales.variant_required}),n&&!w.hasClass("wa-error"))){var _=e('<div class="wa-error-text" />').text(t.locales.variant_required).insertAfter(w);w.addClass("wa-error").one("change",function(){w.removeClass("wa-error"),_.remove()})}}o.length&&(a.errors=o)}return a},n.prototype.render=function(e){var r=this,t=!1;return e.shipping&&e.shipping.html&&(r.$wrapper.replaceWith(e.shipping.html),t=!0),t},n.prototype.renderErrors=function(r){var t=[];return e.each(r,function(e,r){t.push(r)}),t},n.prototype.update=function(e){var r=this;return r.reload=!!e.reload,r.scope.update({sections:["auth","region","shipping","confirm"]}).always(function(){r.reload=!0})},n}(e),o=function(e){return o=function(e){var r=this;r.$wrapper=e.$wrapper,r.$form=r.$wrapper.find("form:first"),r.templates=e.templates,r.disabled=e.disabled,r.errors=e.errors,r.scope=e.scope,r.reload=!0,r.initClass()},o.prototype.initClass=function(){var r=this,t=!1;"object"==typeof r.errors&&Object.keys(r.errors).length&&r.scope.DEBUG("Errors:","error",r.errors),r.$form.on("submit",function(e){e.preventDefault()}),r.$wrapper.on("change","select, textarea, input",function(a){var n=e(this),o=!!n.data("affects-rate")||!!n.data("reload"),i=n.closest(".wa-field-wrapper");i.length||(i=n.parent()),r.scope.validate(i,!0).length||o&&(r.update({reload:!0}),t=!0)}),r.$wrapper.on("focus","select, textarea, input",function(r){t&&e(this).trigger("blur")}),r.initPhotos()},o.prototype.initPhotos=function(){var r=this,t=r.$wrapper.find(".wa-photos-section");if(!t.length)return!1;!function(){var r=function(e){return r=function(e){var r=this;r.$wrapper=e.$wrapper,r.$slides=e.$slides,r.$left_arrow=e.$left_arrow,r.$right_arrow=e.$right_arrow,r.disable_class="is-disabled",r.wrapper_w=null,r.scroll_w=null,r.slide_w=null,r.left=0,r.is_locked=!1,r.initClass()},r.prototype.initClass=function(){function r(){e.contains(document,t.$wrapper[0])?t.wrapper_w!==t.$wrapper.outerWidth()&&t.reset():a.off("resize",r)}var t=this,a=e(window);t.setData(),t.showArrows(),t.$wrapper.on("scroll",function(e){t.left=t.$wrapper.scrollLeft()}),t.$left_arrow.on("click",function(e){e.preventDefault(),t.$left_arrow.hasClass(t.disable_class)||t.move(!1)}),t.$right_arrow.on("click",function(e){e.preventDefault(),t.$right_arrow.hasClass(t.disable_class)||t.move(!0)}),a.on("resize",r)},r.prototype.setData=function(){var e=this;e.wrapper_w=e.$wrapper.outerWidth(),e.scroll_w=e.$wrapper[0].scrollWidth,e.slide_w=e.$slides.first().outerWidth(!0)},r.prototype.showArrows=function(){var e=this,r=e.disable_class;e.left>0?(e.$left_arrow.removeClass(r),e.scroll_w-e.wrapper_w-e.left>0?e.$right_arrow.removeClass(r):e.$right_arrow.addClass(r)):(e.$left_arrow.addClass(r),e.scroll_w-e.wrapper_w>0?e.$right_arrow.removeClass(r):e.$right_arrow.addClass(r))},r.prototype.set=function(e){var r=this;r.is_locked||(r.is_locked=!0,e=e?parseFloat(e):0,e>=0||(e=0),r.$wrapper.animate({scrollLeft:e},200,function(){r.is_locked=!1}),r.left=e)},r.prototype.move=function(e){var r=this,t=4*r.slide_w,a=r.scroll_w-r.wrapper_w,n=0;a>0&&(e?(n=r.left+t,n%r.slide_w>0&&(n=parseInt(r.left/r.slide_w)*r.slide_w),n>a&&(n=a)):(n=r.left-t,n%r.slide_w>0&&(n=parseInt(r.left/r.slide_w)*r.slide_w),n<0&&(n=0))),r.set(n),r.showArrows()},r.prototype.reset=function(){var e=this;e.set(),e.setData(),e.showArrows()},r}(e),a=t.find(".wa-photos-list"),n=a.find(".wa-photo-wrapper");new r({$wrapper:a,$slides:n,$left_arrow:t.find(".js-scroll-prev"),$right_arrow:t.find(".js-scroll-next")})}(),function(){function a(t){function a(r,t){function a(t){if(e.contains(document,r[0])){var n=t.keyCode;37===n?o(!1):39===n&&o(!0)}else e(document).off("keyup",a)}function o(e){u=e?u+1<c.length?u+1:0:u>0?u-1:c.length-1,i(c[u])}function i(r){l.attr("src",r.thumb_uri);var t=e("<img />");t.on("load",function(){l.attr("src")===r.thumb_uri&&(l.attr("src",r.image_uri),p())}),t.attr("src",r.image_uri)}var s=r.find(".wa-photo-body"),l=e("<img />").appendTo(s),c=n(),p=t.onChange||function(){},u=t.index||0;i(c[u]),e(document).on("keyup",a),r.on("click",".js-show-prev",function(e){e.preventDefault(),o(!1)}),r.on("click",".js-show-next",function(e){e.preventDefault(),o(!0)})}var i=r.templates.photo.replace("%title%",o);new r.scope.ui.Dialog({$wrapper:e(i),onOpen:function(e,r){var n=e.find(".js-photo-slider-section");n.length&&a(n,{index:t.index(),onChange:function(){r.resize()}})}})}function n(){var r=[];return t.find(".wa-photo-wrapper").each(function(){var t=e(this),a=t.data("image-uri"),n=t.data("thumb-uri");r.push({image_uri:a,thumb_uri:n})}),r}var o=t.data("name");t.on("click",".js-show-photo",function(r){r.preventDefault(),a(e(this).closest(".wa-photo-wrapper"))})}()},o.prototype.getData=function(e){var r=this,t=[];if(r.disabled)t.push({name:"details[html]",value:"only"});else if(e.clean)t.push({name:"details[html]",value:"only"});else{var a=!1!==e.render_errors;r.$form.length&&(t=r.$form.serializeArray()),!e.only_api&&r.reload&&t.push({name:"details[html]",value:"only"});var n=r.scope.validate(r.$form,a);n.length&&(t.errors=n)}return t},o.prototype.render=function(e){var r=this,t=!1;return e.details&&e.details.html&&(r.$wrapper.replaceWith(e.details.html),t=!0),t},o.prototype.renderErrors=function(r){var t=[];return e.each(r,function(e,r){t.push(r)}),t},o.prototype.update=function(e){var r=this;r.reload=!!e.reload,r.scope.update().always(function(){r.reload=!0})},o}(e),i=function(e){return i=function(e){var r=this;r.$wrapper=e.$wrapper,r.$form=r.$wrapper.find("form:first"),r.disabled=e.disabled,r.locales=e.locales,r.errors=e.errors,r.scope=e.scope,r.reload=!0,r.initClass()},i.prototype.initClass=function(){var r=this,t=!0;"object"==typeof r.errors&&Object.keys(r.errors).length&&r.scope.DEBUG("Errors:","error",r.errors),r.$form.on("submit",function(e){e.preventDefault()}),r.$wrapper.on("change","select, textarea, input",function(a){var n=e(this),o=!!n.data("affects-rate")||!!n.data("reload"),i=n.closest(".wa-field-wrapper");i.length||(i=n.parent()),r.scope.validate(i,!0).length||o&&(r.update({reload:!0}),t=!0)}),r.$wrapper.on("focus","select, textarea, input",function(r){t&&e(this).trigger("blur")}),r.initMethods()},i.prototype.initMethods=function(){function r(e){var r=e.find(".js-method-field");o.length&&o.removeClass(n),o=e.addClass(n),r.attr("checked",!0).trigger("change")}var t=this,a=t.$wrapper.find(".js-methods-list");if(!a.length)return!1;var n="is-active",o=a.find(".wa-method-wrapper."+n);a.on("click",".wa-method-wrapper",function(t){t.preventDefault();var a=e(this);o.length?o[0]!==a[0]&&r(a):r(a)})},i.prototype.getData=function(r){var t=this,a=[];if(t.disabled)a.push({name:"payment[html]",value:"only"});else if(r.clean)a.push({name:"payment[html]",value:"only"});else{var n=!1!==r.render_errors;t.$form.length&&(a=t.$form.serializeArray()),!r.only_api&&t.reload&&a.push({name:"payment[html]",value:1});var o=t.scope.validate(t.$wrapper,n),i=t.$wrapper.find(".js-methods-list");if(i.length){var s=i.find(".js-method-field:checked");if(!s.length&&(o.push({$wrapper:i,id:"method_required",value:t.locales.method_required}),n)){if(!i.hasClass("wa-error")){var l=e('<div class="wa-error-text" />').text(t.locales.method_required).insertAfter(i);i.addClass("wa-error").one("change",function(){i.removeClass("wa-error"),l.remove()})}}}o.length&&(a.errors=o)}return a},i.prototype.render=function(e){var r=this,t=!1;return e.payment&&e.payment.html&&(r.$wrapper.replaceWith(e.payment.html),t=!0),t},i.prototype.renderErrors=function(r){var t=[];return e.each(r,function(e,r){t.push(r)}),t},i.prototype.update=function(e){var r=this;return e.reload&&(r.reload=!0),r.scope.update()},i}(e),s=function(e){return s=function(e){var r=this;r.$wrapper=e.$wrapper,r.$form=r.$wrapper.find("form:first"),r.$submit_button=r.$wrapper.find(".js-submit-order-button"),r.templates=e.templates,r.errors=e.errors,r.scope=e.scope,r.urls=e.urls,r.reload=!0,r.is_locked=!1,r.is_channel_confirm_skiped=!1,r.initClass()},s.prototype.initClass=function(){function r(){e.contains(document,t.$wrapper[0])?n=JSON.stringify(t.scope.getFormData()):t.scope.$wrapper.off("ready changed",r)}var t=this;"object"==typeof t.errors&&Object.keys(t.errors).length&&(t.scope.DEBUG("Errors:","error",t.errors),t.renderErrors(t.errors)),t.$form.on("submit",function(e){e.preventDefault()}),t.$wrapper.on("change","select, input, textarea",function(r){var a=e(this),n=a.closest(".wa-field-wrapper");a.data("reload")?t.update({reload:!0}):n.length&&t.scope.validate(n,!0)});var a=t.$wrapper.find(".wa-comment-section");if(a.length){a.on("click"," .js-open-section",function(e){e.preventDefault(),a.toggleClass("is-opened")})}t.$wrapper.on("click",".js-show-terms-dialog",function(r){r.preventDefault(),t.templates.terms_dialog&&new t.scope.ui.Dialog({$wrapper:e(t.templates.terms_dialog)})});var n="";t.scope.$wrapper.on("ready changed",r),t.$submit_button.on("click",function(e){if(e.preventDefault(),!t.is_locked){t.is_locked=!0;var r=null;if("create"===t.$submit_button.data("action")){var a=JSON.stringify(t.scope.getFormData());r=n!==a?t.scope.update():t.create()}else r=t.scope.update();r.always(function(){t.is_locked=!1}).done(function(e){e.order_id&&(t.buttonAnimation(!0),t.is_locked=!0)})}})},s.prototype.getData=function(e){var r=this,t=[];if(e.clean)t.push({name:"confirm[html]",value:"only"});else{var a=!1!==e.render_errors;r.$form.length&&(t=r.$form.serializeArray()),!e.only_api&&r.reload&&t.push({name:"confirm[html]",value:1});var n=r.scope.validate(r.$wrapper,a);n.length&&(t.errors=n)}return t},s.prototype.render=function(e){var r=this,t=!1;return e.confirm&&e.confirm.html&&(r.$wrapper.replaceWith(e.confirm.html),t=!0),t},s.prototype.renderErrors=function(r){function t(r){e.each(r,function(e,r){switch(r.id){case"cart_invalid":a.$wrapper.trigger("wa_order_cart_invalid");break;case"confirm_channel":var t=r.type,n=!!r.auth_with_code;a.showChannelConfirmDialog(t,n),o=!1}})}var a=this,n=[],o=!0,i=[],s=[];return e.each(r,function(e,r){"cart_invalid"===r.id?i.push(r):s.push(r)}),i.length?t(i):s.length&&(t(s),n=s),n.focus=o,n},s.prototype.update=function(e){var r=this;return e.reload&&(r.reload=!0),r.scope.update()},s.prototype.create=function(){function r(r){function t(e){var r=0;if(e.is(":visible"))r=e.offset().top;else{var a=e.parent();a.length&&(r=t(a))}return r}var a=0;if(r.$field&&r.$field.length){a=t(r.$field)-40,r.$field.focus()}r.$wrapper&&r.$wrapper.length&&(a=r.$wrapper.offset().top-40),e("html, body").scrollTop(a)}var t=this,a=e.Deferred(),n=t.scope.validate(t.scope.$wrapper,!0);return n.length?(t.scope.DEBUG("Errors:","error",n),r(n[0]),a.reject()):function(e){t.scope.update({create:!0,render_errors:!0}).then(function(a){if(a.order_id){t.scope.trigger("created",a),t.scope.lock(!0);try{location.href=t.scope.urls.success
}catch(e){t.scope.DEBUG(e.message,"error")}}else{var n=t.scope.renderErrors(a);n.length&&n.focus&&r(n[0])}e.resolve(a)},function(t,a){"front_errors"===t&&a.length&&r(a[0]),e.reject()})}(a),a.promise()},s.prototype.showChannelConfirmDialog=function(r){function t(){a.$submit_button.trigger("click")}var a=this,n=a.urls.channel_dialog,o={source:function(){var t="";if("phone"===r){var a=e("input[name='auth[data][phone]']");a.length&&(t=a.val())}else if("email"===r){var n=e("input[name='auth[data][email]']");n.length&&(t=n.val())}return t}()};a.scope.lock(!0),e.post(n,o).done(function(r){if("ok"===r.status){var n=r.data.confirmation_dialog,o=e(n);o.data("scope",a);new a.scope.ui.Dialog({$wrapper:o,options:{onSuccess:function(r){if("phone"===r.type){var a=e("input[name='auth[data][phone]']");a.length&&a.val(r.value)}else if("email"===r.type){var n=e("input[name='auth[data][email]']");n.length&&n.val(r.value)}t()},onSkip:function(){a.is_channel_confirm_skiped=!0,t()}},onClose:function(){a.scope.lock(!1)}})}else a.scope.DEBUG("Channel confirm dialog error","error")})},s.prototype.initChannelConfirm=function(r){var t=function(e){function r(e,r){var t=!1;switch(r){case"phone":t=window.waOrder.ui.validate.phone(e);break;case"email":t=window.waOrder.ui.validate.email(e);break;default:t=!0}return t}return t=function(e){var r=this;r.$wrapper=e.$wrapper,r.$code_field=r.$wrapper.find(".js-code-field"),r.$value_field=r.$wrapper.find(".js-value-field"),r.$errors_w=r.$wrapper.find(".js-errors-wrapper"),r.recode_timeout=e.recode_timeout,r.dialog=r.$wrapper.data("dialog"),r.scope=r.$wrapper.data("scope"),r.locales=e.locales,r.urls=e.urls,r.type=e.type,r.init()},t.prototype.init=function(){var e=this;e.initSendCode(),e.initSubmit()},t.prototype.initSendCode=function(){function t(e){e?(i.$value_field.attr("readonly",!0),p.hide(),u.show(),d.show()):(i.$value_field.attr("readonly",!1),p.show(),u.hide(),d.hide())}function a(e){e?(h.hide(),f.show()):(f.hide(),h.show())}function n(){var r=e.Deferred(),t=i.$value_field.val();if(t.length){if(!s){s=!0;var a=i.urls.code,n={source:t,type:i.type};e.post(a,n).done(function(e){if("ok"===e.status)r.resolve();else{var t=[];e.errors&&(t=e.errors),r.reject(t)}}).fail(function(){r.reject()}).always(function(){s=!1})}}else i.$value_field.focus(),r.reject();return r.promise()}function o(){function r(e){if(!((e=parseInt(e))>=0))return"";var r=parseInt(e/60),t=e-60*r;return r<10&&(r="0"+r),t<10&&(t="0"+t),r+":"+t}var t=e.Deferred(),n=0,o=i.recode_timeout;return a(!1),v.html(r(o)),c=setInterval(function(){n++,e.contains(document,v[0])?n>=o?(clearInterval(c),a(!0),t.resolve()):v.html(r(o-n)):(clearInterval(c),t.reject())},1e3),t.promise()}var i=this,s=!1,l=!1,c=0,p=i.$wrapper.find(".js-send-line"),u=i.$wrapper.find(".js-code-line"),d=i.$wrapper.find(".js-submit-line"),f=u.find(".js-resend-code"),h=u.find(".js-timer-wrapper"),v=h.find(".wa-time");i.$wrapper.on("click",".js-send-code",function(e){if(e.preventDefault(),!r(i.$value_field.val(),i.type))return i.renderError({$field:i.$value_field,text:i.locales.invalid}),!1;n().then(function(){t(!0),o()},function(e){i.renderErrors(e)})}),i.$wrapper.on("click",".js-resend-code",function(e){e.preventDefault(),l||(l=!0,n().then(function(){o(),l=!1},function(e){i.renderErrors(e)}))}),i.$wrapper.on("click",".js-edit-value",function(e){e.preventDefault(),t(!1)})},t.prototype.initSubmit=function(){function t(){if(!n){n=!0;var t=a.$code_field.val(),o=a.$value_field.val(),i=r(o,a.type);if(!t.length)return a.renderError({$field:a.$code_field,text:a.locales.code_empty}),n=!1,!1;if(!i)return a.renderError({$field:a.$value_field,text:a.locales.invalid}),n=!1,!1;var s=a.urls.submit,l={code:t,value:o};e.post(s,l).done(function(e){e.errors?a.renderErrors(e.errors):(a.dialog.close(),a.dialog.options.onSuccess({type:a.type,value:o}))}).always(function(){n=!1})}}var a=this,n=!1;a.$wrapper.on("click",".js-submit-confirm",function(e){e.preventDefault(),t()}),a.$wrapper.on("click",".js-skip-confirm",function(e){e.preventDefault(),a.dialog.close(),a.dialog.options.onSkip()})},t.prototype.renderErrors=function(r){var t=this;t.$errors_w.html(""),r.length&&e.each(r,function(r,a){if(a.text){var n=e('<div class="wa-error-text" />').text(a.text);t.$errors_w.append(n)}}),t.scope.scope.DEBUG("ERRORS:","error",r)},t.prototype.renderError=function(r){function t(){o.removeClass(n),a.remove(),o.off("change",t)}var a=e('<div class="wa-error-text" />').text(r.text),n="wa-error";if(r.$field){var o=r.$field;if(!o.hasClass(n)){o.addClass(n);var i=o.closest(".wa-field-wrapper");i.length?i.append(a):a.insertAfter(o),o.on("change keyup",t)}}},t}(e);new t(r)},s.prototype.buttonAnimation=function(e){var r=this,t=r.$submit_button,a=r.templates.loading_html,n="";if(e){var o=t.width();n=t.html(),t.data("html_before",n).width(o).addClass("is-loading").html(a)}else n=t.data("html_before"),t.removeAttr("style").removeClass("is-loading").html(n)},s}(e),l=function(e){function r(r){return r.errors&&(Array.isArray(r.errors)||(r.errors=function(r){var t=[];return r&&e.each(r,function(e,r){t.push({name:e,value:r})}),t}(r.errors))),r}return l=function(r){var t=this;if(!(r.outer_options&&"string"==typeof r.outer_options.wrapper&&r.outer_options.wrapper.length>0))throw new Error("Checkout wrapper element not specified.");var a=e(r.outer_options.wrapper);if(1!==a.length)throw new Error("Error: Checkout form wrapper element must be exactly one on page (found "+a.length+")");if(!r.urls.calculate)throw new Error("Must specify url_calculate");if(!r.urls.create)throw new Error("Must specify url_create_order");t.$outer_wrapper=a,t.$wrapper=r.$wrapper,t.options=r.outer_options,t.locales=r.locales,t.urls=r.urls,t.ui=window.waOrder.ui,t.sections={},t.render_scheduled=!1,t.calculate_promise=null,t.create_promise=null,t.calculate_xhr=null,t.reload_xhr=null,t.create_xhr=null,t.initClass()},l.prototype.initClass=function(){function r(){var e=i.getFormData({sections:["auth","region","confirm"]});i.update({data:e}).then()}function t(){e.contains(document,i.$wrapper[0])?i.update().then():s.off("wa_order_cart_changed wa_order_product_added",t)}function a(){e.contains(document,i.$wrapper[0])?i.reload():s.off("wa_auth_contact_logout",a)}function n(){e.contains(document,i.$wrapper[0])?(s.trigger("wa_order_reload_start"),location.reload()):e(document).off("wa_auth_contact_logged",n)}function o(){e.contains(document,i.$wrapper[0])?i.lock(!0):s.off("wa_order_reload_start",o)}var i=this,s=e(document);i.$wrapper.find(".wa-form-body > .wa-form-loader").remove(),i.$wrapper.removeClass("is-not-ready").find(".js-invisible-content").removeAttr("style").removeClass("js-invisible-content"),i.$outer_wrapper.data("controller",i),i.$wrapper.data("ready").resolve(i),i.trigger("ready",i),i.$wrapper.on("region_change",r),s.on("wa_order_cart_changed wa_order_product_added",t),s.on("wa_auth_contact_logout",a),s.on("wa_auth_contact_logged",n),s.on("wa_order_reload_start",o),i.$wrapper.find("input:visible").each(function(){var r=e(this);if(!e.trim(r.val()).length)return r.trigger("focus"),!1})},l.prototype.DEBUG=function(){var e=this,r=console.log,t={hint:"font-weight: bold; color: #666;",info:"font-weight: bold; font-size: 1.25em; color: blue;",warn:"font-weight: bold; font-size: 1.25em;",error:"font-weight: bold; font-size: 1.25em;"};if(e.options&&e.options.DEBUG){if(t[arguments[1]]){switch(arguments[0]="string"==typeof arguments[0]?"%c"+arguments[0]:arguments[0],arguments[1]){case"info":r=console.info;break;case"error":r=console.error;break;case"warn":r=console.warn}arguments[1]=t[arguments[1]]}return r.apply(console,arguments)}},l.prototype.initAuth=function(e){var r=this;e.scope=r,r.sections.auth=new t(e),r.DEBUG("Auth initialized","info",r.sections.auth)},l.prototype.initRegion=function(e){var r=this;e.scope=r,r.sections.region=new a(e),r.DEBUG("Region initialized","info",r.sections.region)},l.prototype.initShipping=function(e){var r=this;e.scope=r,r.sections.shipping=new n(e),r.DEBUG("Shipping initialized","info",r.sections.shipping)},l.prototype.initDetails=function(e){var r=this;e.scope=r,r.sections.details=new o(e),r.DEBUG("Details initialized","info",r.sections.details)},l.prototype.initPayment=function(e){var r=this;e.scope=r,r.sections.payment=new i(e),r.DEBUG("Payment initialized","info",r.sections.payment)},l.prototype.initConfirm=function(e){var r=this;e.scope=r,r.sections.confirm=new s(e),r.DEBUG("Confirm initialized","info",r.sections.confirm)},l.prototype.trigger=function(e,r){var t=this,a="wa_order_form_"+e;t.$wrapper.triggerHandler(e,r||null),t.$outer_wrapper.trigger(a,r||null)},l.prototype.validate=function(r,t){function a(r){function t(){o.removeClass(n),a.remove(),o.off("change",t)}var a=e('<div class="wa-error-text" />').text(r.value),n="wa-error";if(r.$field){var o=r.$field;if(!o.hasClass(n)){o.addClass(n);var i=o.closest(".wa-field-wrapper");i.length?i.append(a):a.insertAfter(o),o.on("change keyup",t)}}}var n=this,o=[];return r.find(".wa-input").each(function(){var r=e(this),t=r.attr("name"),a=r.val().trim();if(r.is(":disabled"))return!0;if(a.length){if(!t)return!0;if(r.hasClass("wa-email")){n.ui.validate.email(a)||o.push({$field:r,name:t,value:n.locales.invalid})}else if(r.hasClass("wa-phone")){var i=n.ui.validate.phone(a);i||o.push({$field:r,name:t,value:n.locales.invalid})}else if(r.hasClass("wa-url")){var s=n.ui.validate.url(a);s||o.push({$field:r,name:t,value:n.locales.invalid})}else if(r.hasClass("wa-number")){var l=n.ui.validate.number(a);l||o.push({$field:r,name:t,value:n.locales.invalid})}}else{!!r.attr("required")&&o.push({$field:r,name:t,value:n.locales.required})}}),r.find(".wa-checkbox").each(function(){var r=e(this),t=r.attr("name"),a=r.is(":checked");if(r.is(":disabled"))return!0;if(a){if(!t)return!0}else{!!r.attr("required")&&o.push({$field:r,name:t,value:n.locales.required})}}),r.find(".wa-select, wa-textarea").each(function(){var r=e(this),t=r.attr("name"),a=e.trim(r.val());if(r.is(":disabled"))return!0;if(a.length){if(!t)return!0}else{!!r.attr("required")&&o.push({$field:r,name:t,value:n.locales.required})}}),t&&o.length&&e.each(o,function(e,r){a(r)}),o},l.prototype.renderErrors=function(r){var t=this,a=[];return r.error_step_id&&r.errors&&e.each(t.sections,function(e,t){if(r.error_step_id===e&&"function"==typeof t.renderErrors){var n=t.renderErrors(r.errors);n.length&&(a=a.concat(n))}}),a},l.prototype.getFormData=function(r){r=r||{};var t=this,a=[],n=[],o=!!r.render_errors;return e.each(t.sections,function(e,t){var i=!1;if(r.sections&&Array.isArray(r.sections)&&(r.sections.indexOf(e)>=0||(i=!0)),"function"==typeof t.getData){var s=o&&!n.length,l=t.getData({clean:i,only_api:!!r.only_api,render_errors:s});l.length&&(a=a.concat(l)),l.errors&&(n=n.concat(l.errors))}}),n.length&&(a.errors=n,t.DEBUG("Errors:","warn",n)),a},l.prototype.update=function(r){r=r||{};var t=this,a=e.Deferred(),n=a.promise(),o=[],i=!!r.render_errors,s=!1;if(r.data)o=r.data;else{var l={render_errors:i};r.sections&&(l.sections=r.sections),o=t.getFormData(l)}if(i&&o.errors)return a.reject("front_errors",o.errors),n;n=r.create?t.create(o):t.calculate(o);var c=["auth","region","shipping","details","payment","confirm"];return e.each(c,function(e,r){var a=null;if(!t.sections[r])return!0;a=t.sections[r],a.$wrapper.addClass("is-locked"),"confirm"===r&&a.buttonAnimation(!0),n.always(function(){"confirm"===r&&a.buttonAnimation(!1),a.$wrapper.removeClass("is-locked")}).then(function(e){if("function"==typeof a.render){a.render(e)&&(s=!0,t.trigger(r+"_changed",e))}},function(e,r){r&&t.DEBUG("render errors:","errors",r)})}),n.then(function(e){s&&t.trigger("changed",e)}),n},l.prototype.calculate=function(t){function a(){if(!t)return n.DEBUG("Form data is required.","error"),o.reject("error"),!1;t.push({name:"response",value:"json"}),n.DEBUG("Form data:","info"),n.DEBUG(t),n.calculate_xhr=e.post(n.urls.calculate,t,"json").done(function(e){if("ok"===e.status){var t=r(e.data);n.DEBUG("API received:","info"),n.DEBUG(t),o.resolve(t)}else n.DEBUG("API not received.","error",e.errors?e.errors:"No error description"),o.reject("fail",e)}).fail(function(e,r){"abort"===r?a():(n.DEBUG("Getting API aborted.","error",r),o.reject(r))})}var n=this;if(n.calculate_promise)return n.calculate_xhr&&n.calculate_xhr.abort(),n.calculate_promise;var o=e.Deferred();return n.calculate_promise=o.promise(),n.calculate_promise.then(function(){n.calculate_promise=null,n.calculate_xhr=null},function(){n.calculate_promise=null,n.calculate_xhr=null}),a(),n.calculate_promise},l.prototype.create=function(t){var a=this;if(a.create_promise)return a.create_xhr&&a.create_xhr.abort(),a.create_promise;var n=e.Deferred();return a.create_promise=n.promise(),a.create_promise.then(function(){a.create_promise=null,a.create_xhr=null},function(){a.create_promise=null,a.create_xhr=null}),function(){if(!t)return a.DEBUG("Form data is required.","error"),n.reject("error"),!1;t.push({name:"response",value:"json"}),a.DEBUG("Form data for create:","info"),a.DEBUG(t),a.create_xhr=e.post(a.urls.create,t,"json").done(function(e){if("ok"===e.status){var t=r(e.data);a.DEBUG("API received:","info"),a.DEBUG(t),n.resolve(t)}else a.DEBUG("API not received.","error",e.errors?e.errors:"No error description"),n.reject("fail",e)}).fail(function(e,r){a.DEBUG("Getting API aborted.","error",r),n.reject(r)})}(),a.create_promise},l.prototype.reload=function(){var r=this,t=e.Deferred();if(!r.reload_xhr){r.calculate_xhr&&(r.calculate_xhr.abort(),r.calculate_xhr=!1),r.lock(!0);var a=r.getFormData({only_api:!0});r.options&&(a.push({name:"opts[DEBUG]",value:r.options.DEBUG?1:0}),a.push({name:"opts[wrapper]",value:r.options.wrapper}),void 0===r.options.adaptive||r.options.adaptive&&"false"!==r.options.adaptive||a.push({name:"opts[adaptive]",value:"false"})),a.push({name:"response",value:"html"}),r.DEBUG("Form is reloading...","info",a),r.trigger("before_reload",r),r.reload_xhr=e.post(r.urls.calculate,a).done(function(e){r.$outer_wrapper.one("wa_order_form_ready",function(){var e=r.$outer_wrapper.data("controller");t.resolve(e)}),r.$wrapper.replaceWith(e),r.DEBUG("Form reloaded.","info"),r.trigger("reloaded",r)}).fail(function(e,a){r.DEBUG("Reload is failed.","error",a),t.reject(a)}).always(function(){r.lock(!1),r.reload_xhr=!1})}return t.promise()},l.prototype.lock=function(e){var r=this;e?r.$wrapper.addClass("is-locked"):r.$wrapper.removeClass("is-locked")},l}(e);window.waOrder=window.waOrder||{},window.waOrder.Form=l}(jQuery);
//# sourceMappingURL=form.min.js.map
