{strip}
{capture assign="_info_icon"}
<span class="icon baseline size-12 custom-mr-4 text-dark-gray"><i class="fas fa-info-circle"></i></span>
{/capture}
{assign var=currency_warning value=
'<div class="alert small warning custom-mt-24">
    <i class="fas fa-exclamation-triangle"></i>
    <strong>Экспортированные цены товаров могут отличаться от цен товаров на витрине</strong>
    <br><br>
    Это может привести к штрафным санкциям со стороны «Яндекс.Маркета».
    <br><br>
    Как исправить:
    <ol>
        <li>Для настройки плагина «<em>Основная валюта</em>» выберите валюту, соответствующую валюте витрины.</li>
        <li>Для настройки плагина «<em>Конвертация цен в основную валюту</em>» выберите «<strong>Цены в любой валюте, отличной от основной, будут сконвертированы в основную валюту</strong>».</li>
    </ol>
    Цены товаров могут быть сохранены в разных валютах.
</div>'}

<div class="ymarket-setup-page ymarket-setup-page-wa-2" id="s-yandexmarket-form">
    <p>Экспорт каталога товаров в формате YML</p>
{if $settlements}
    <form id="s-plugin-yandexmarket" method="post" action="?plugin=yandexmarket&module=run">
    <div class="fields form">

        {if $info.exists}
            <div class="field-group">
                <div class="field">
                    <div class="name bold">
                        YML-файл
                    </div>
                    <div class="value">
                        <input id="s-plugin-yandexmarket-last-export" class="bold width-70" type="text" value="{$info.url|escape}" readonly="readonly">
                        <a href="{$info.url}?download=1" class="custom-ml-8 bold nowrap inline"><i class="fas fa-file-download"></i>&nbsp;Скачать</a>
                        <p class="small">Файл обновлен: {$info.mtime|wa_datetime:"humandatetime"}</p>
                        <p class="small"><i class="fas fa-check text-green"></i> Ссылка на YML-файл постоянна для этого профиля и не изменяется при повторном экспорте товаров.<br>
                        Чтобы сделать ссылку недействительной, удалите профиль.</p>

                        <div class="alert small width-70">
                            <div class="flexbox space-4">
                               <span><i class="fas fa-info-circle"></i></span>
                                <div>
                                    <div>Команда CRON для автоматического обновления файла:</div>
                                    <pre>{$cron_command|escape}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {/if}

        {if $error_currency}
        <div class="field">
            {$currency_warning}
        </div>
        {/if}

        <div class="field-group ">
            <div class="field js-profile-description">
                <div class="name">Название профиля</div>
                <div class="value">
                    <input type="text" name="profile[name]" value="{$profile.name|default:''|escape}" placeholder="Название профиля" id="s-plugin-yandexmarket-profile-name" class="long">
                    <input type="hidden" name="profile[id]" value="{$profile.id|default:'-1'}">
                </div>

            </div>

            <div class="field">
                <div class="name">
                    Обновление файла
                </div>
                <div class="value">
                    <select name="lifetime" id="s-plugin-yandexmarket-ondemand-update">
                        <option value="0"{if $profile.config.lifetime ==0} selected="selected"{/if}>Обновление только вручную</option>
                        <option value="60"{if $profile.config.lifetime ==60} selected="selected"{/if}>Автоматически при каждом запросе, но не чаще, чем раз в минуту</option>
                        <option value="3600"{if $profile.config.lifetime ==3600} selected="selected"{/if}>Автоматически, но не чаще чем раз в час</option>
                        <option value="86400"{if $profile.config.lifetime ==86400} selected="selected"{/if}>Автоматически, но не чаще чем раз в день</option>
                        <option value="604800"{if $profile.config.lifetime ==604800} selected="selected"{/if}>Автоматически, но не чаще чем раз в неделю</option>
                    </select>
                    <p class="hint">Включите <em>автоматический экспорт</em> товаров, и YML-файл будет обновляться каждый раз при запросе его URL, если возраст файла больше выбранного значения.<br>
                    Если автоматическое обновление не выбрано, то по адресу файла будет доступна его последняя версия, экспортированная вручную.</p>

                    <div class="custom-mt-16">
                        <label>
                            <input name="force_update" id="s-plugin-yandexmarket-force-update" type="checkbox" value="1"{if !empty($profile.config.force_update)} checked="checked"{/if}> Обновлять файл, даже если в выгрузку не попадает ни одного товарного предложения
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="field-group ">
            <h2>1. Данные магазина</h2>
            <div class="field">
                <div class="name">Название магазина</div>
                <div class="value">
                    <input type="text" name="company_name" placeholder="Название" value="{$company_name|escape}" id="s-plugin-yandexmarket-company-name" class="long">&rarr;&lt;name&gt;
                    <br>
                    <p class="hint">Короткое название магазина — название, которое выводится в списке товаров, найденных на «Яндекс.Маркете».</p>
                </div>
            </div>

            <div class="field">
                <div class="name">Компания</div>
                <div class="value">
                    <input type="text" name="company" placeholder="Компания" value="{$company|escape}" id="s-plugin-yandexmarket-company" class="long">&rarr;&lt;company&gt;
                    <br>
                    <p class="hint">Полное наименование компании, владеющей магазином. Не публикуется, используется для внутренней идентификации.</p>
                </div>
            </div>

            <div class="field">
                <div class="name">Номер телефона</div>
                <div class="value">
                    <input type="text" name="company_phone" placeholder="{$default_phone|escape}" value="{$company_phone|escape}" id="s-plugin-yandexmarket-phone" class="long">&rarr;&lt;phone&gt;
                    <br>
                    <p class="hint">Если оставить это поле пустым, будет экспортирован телефонный номер из «<a href="?action=settings">Общих настроек</a>».<br>
                        Если нужно, впишите другой номер для этого профиля экспорта.</p>
                </div>
            </div>
        </div>

        <div class="field-group  ">
            <h2>2. Настройки URL</h2>

            <div class="field">
                <div class="name">
                    Витрина
                </div>
                <div class="value">
                {if count($settlements)>1}
                    <select name="domain" id="s-plugin-yandexmarket-domain">
                        {foreach $settlements as $route}
                            <option value="{$route|escape}"{if $route eq $current_domain} selected="selected"{/if}>{waIdna::dec($route)|escape}</option>
                        {/foreach}
                    </select>
                    <br/>
                    <span class="hint">Витрину необходимо указать для правильного формирования адресов страниц товаров в YML-файле и отбора товаров для экспорта.</span>
                {elseif reset($settlements)}
                    {$route = reset($settlements)}
                    <input type="text" readonly="readonly" value="{$route|escape}" name="domain" id="s-plugin-yandexmarket-domain">
                    <br/>
                    <span class="hint">Витрину необходимо указать для правильного формирования адресов страниц товаров в YML-файле и отбора товаров для экспорта.</span>
                {else}
                    <span class="state-error-hint">Не удалось обнаружить витрину магазина. Проверьте настройки поселения магазина в разделе «Витрина».</span>
                {/if}
                    <div class="custom-mt-8 custom-mb-16">
                        <label><input type="checkbox" name="ssl" value="1" {if !empty($profile.config.ssl)} checked="checked"{/if}> Формировать ссылки, используя адреса с <em>https://</em></label>
                    </div>
                </div>
            </div>
            <div class="field js-profile-description">
                <div class="name">UTM-метки</div>
                <div class="value">
                    <div>
                        Источник (utm_source):<br>
                        <input type="text" name="utm_source" class="long" placeholder="yandexmarket" value="{$profile.config.utm_source|default:''|escape}" >
                    </div>
                    <div class="custom-my-8">
                        Канал (utm_medium):<br>
                        <input type="text" name="utm_medium" class="long" placeholder="cpc" value="{$profile.config.utm_medium|default:''|escape}" >
                    </div>
                    <div>
                        Кампания (utm_campaign):<br>
                        <input type="text" name="utm_campaign" class="long" placeholder="{$profile.name|default:''|escape}" value="{$profile.config.utm_campaign|default:''|escape}" >
                    </div>
                    <p class="hint">Ко всем адресам (URL), содержащимся в файле, будут автоматически добавлены UTM-метки, которые позволят средствам веб-аналитики отслеживать переходы посетителей сайта по этим адресам.  Если вы не используете UTM-метки, просто оставьте поля пустыми.</p>
                </div>
            </div>
            <div class="field js-profile-description">
                <div class="name">Дополнительные параметры в URL</div>
                <div class="value ">
                    <textarea name="custom_url" class="width-90" placeholder="utm_my_param1=100500&extraparam=500100&my_var=%sku%">{$profile.config.custom_url|default:''|escape}</textarea>
                    <div class="hint">
                        Ко всем адресам (URL), содержащимся в файле, будут автоматически добавлена строка, сформированная на основе шаблона параметров, разделенных символом <tt>&amp;</tt>.<br/>
                        <a class="flexbox inline-link middle space-4" id="js-cheatsheet-crib" href="#">
                            <i class="fas fa-book-open"></i>
                            <b>
                                <i>Шпаргалка</i>
                            </b>
                            <i class="arrow fas fa-caret-right"></i>
                        </a>
                    </div>
                    <div class="value " id="js-cheatsheet-crib-content" style="display: none;">
                        <div class="alert outlined width-80">
                            Возможные переменные для использования в шаблоне:
                            <ul class="menu">
                                <li><b>%id%</b> — id товара</li>
                                <li><b>%sku%</b> — артикул товара</li>
                                <li><b>%name%</b> — название товара</li>
                                <li><b>%contact_id%</b> — id контакта, создавшего товар</li>
                                <li><b>%badge%</b> — значок на товаре</li>
                                <li><b>%offer.id%</b> — id товарного предложения</li>
                            </ul>
                            <b>Примеры:</b><br/>
                            utm_term=%id% (для PriceLab дополнительно заполните поле utm_source)<br/>
                            promo_id=1234 (для указания реферальной ссылки)
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="clear-left"></div>
    <div class="field-group  ">
        <h2>3. Экспорт товаров</h2>
        {$hash = $profile.config.hash}
{*BEGIN*}

{*
@var array $set array of available sets
@var array $types array of available product types
@var array $hint array of hash hints
@var string $hash
*}
        {if true}
            {include file="../../../../../templates/includes/productSelectorWa2.html"}
            <div class="field custom-mt-4">
                <div class="value submit">
                    <p class="hint custom-mb-16"><i class="fas fa-exclamation-triangle text-yellow"></i>&nbsp;Если товар не принадлежит ни к одной категории, то он не будет экспортирован в YML-файл.</p>
                    <label>
                        <input type="checkbox" name="trace" value="1"{if !empty($trace)} checked="checked"{/if}>&nbsp;<span class="hint">Логировать предложения, не попавшие в выгрузку, в файл <tt>wa-log/shop/plugins/yandexmarket/export.trace.{$profile.id}.log</tt>.</span>
                    </label>
                </div>
            </div>
        {else}
        <div class="field">
            <div class="name">
                {_wd('shop',"Select products")}
            </div>
            {$hash = shopImportexportHelper::parseHash($hash)}
            <div class="value">
                <div class="sidebar">
                    <ul class="menu">
                        <li class="bottom-padded">
                            <label class="black"><input type="radio" value="" name="hash"{if empty($hash.type)} checked="checked"{/if}> {_wd('shop',"All products")}</label>
                        </li>
                        <li{if $hash.type neq 'id'} style="display: none;"{/if} class="bottom-padded">
                            <label class="black"><input type="radio" value="id" name="hash"{if $hash.type eq 'id'} checked="checked"{/if}>
                                <input type="hidden" value="{$hash.product_ids|default:''}" name="product_ids"> <span>{if $hash.type eq 'id'}{$hash.count|string_format:"{_wd('shop',"Selected products (%d)")}"}{else}{_wd('shop',"Selected products (%d)")}{/if}</span></label>
                        </li>
                        <li{if $hash.type neq 'category'} style="display: none;"{/if} class="bottom-padded">
                            <label class="black"><input type="radio" value="category" name="hash"{if $hash.type eq 'category'} checked="checked"{/if}>
                                <input type="hidden" value="{$hash.category_ids|default:''}" name="category_ids"> <span>{if $hash.type eq 'category'}{$hash.count|string_format:"{_wd('shop',"Selected categories (%d)")}"}{else}{_wd('shop',"Selected categories (%d)")}{/if}</span></label>
                        </li>
                        <li class="bottom-padded">
                            <label class="black"><input type="radio" value="set" name="hash"{if $hash.type eq 'set'} checked="checked"{/if}> {_wd('shop',"Sets")}</label>
                        </li>
                        <li class="bottom-padded">
                            <label class="black"><input type="radio" value="type" name="hash"{if $hash.type eq 'type'} checked="checked"{/if}> {_wd('shop',"Product types")}</label>
                        </li>
                    </ul>
                </div>
                <div class="value js-hash-values js-hash-set" style="width: 400px;">
                    <div class="bordered-left" style="padding-left: 20px; margin-left: 20px;">
                        <ul class="menu with-icons">
                            {foreach $sets as $set}
                                <li class="bottom-padded">
                                    <label title="{$set.id|escape}">
                                        <span class="count">{if !empty($set.type)}&le;{/if}{$set.count}</span>
                                        <span class="icon text-gray"><i class="fas fa-{if $set.type == shopSetModel::TYPE_DYNAMIC}filter{else}bars{/if}"></i></span>
                                        <input type="radio" name="set_id" value="{$set.id}"{if ($set@first && empty($hash.set_id))||($hash.set_id eq $set.id)} checked="checked"{/if}>
                                        {$set.name|escape}
                                    </label>
                                </li>
                            {/foreach}
                        </ul>
                        {if !empty($hints.set)}<br/><span class="gray">{$hints.set}</span>{/if}
                    </div>
                </div>
                <div class="value js-hash-values js-hash-type" style="width: 400px;">
                    <div class="bordered-left" style="padding-left: 20px; margin-left: 20px;">
                        <ul class="menu with-icons">
                            {foreach $types as $type}{if $type.count}
                                <li class="bottom-padded">
                                    <label class="flexbox middle space-4">
                                        <span class="count">{$type.count}</span>
                                        <span class="icon text-gray">{$wa->shop->getIcon($type.icon)}</span>
                                        <span><input type="radio" name="type_id" value="{$type.id}" {if ($type@first && empty($hash.type_id))||($hash.type_id eq $type.id)} checked="checked"{/if}> {$type.name|escape}</span>
                                    </label>
                                </li>
                            {/if}{/foreach}
                        </ul>
                        {if !empty($hints.type)}<br/><span class="gray">{$hints.type}</span>{/if}
                    </div>
                </div>
                <div class="clear-left"></div>
                <p class="hint"><i class="fas fa-exclamation-triangle text-yellow"></i> Если товар не принадлежит ни к одной категории, то он не будет экспортирован в YML-файл.</p>
            </div>



            <div class="value">
                <label><input type="checkbox" name="trace" value="1"{if !empty($trace)} checked="checked"{/if}>&nbsp;<span class="hint">Логировать предложения, не попавшие в выгрузку, в файл <tt>wa-log/shop/plugins/yandexmarket/export.trace.{$profile.id}.log</tt>.</span></label>
            </div>
        </div>
        {/if}


        <div class="field">
            <div class="name for-checkbox">Фильтр</div>
            <div class="value ">
                <label>
                    <input type="checkbox" name="export[skip_ignored]" value="1"
                           {if !empty($export.skip_ignored)}checked="checked"{/if}
                           id="s-plugin-yandexmarket-export-skip_ignored"> Товары, у которых в дополнительных параметрах указано значение <tt>yandexmarket.ignored=1</tt>, не будут экспортированы в YML-файл.
                </label>
                <p class="hint">Добавить дополнительный параметр возможно при редактировании товара, на вкладке «Описание и SEO», в поле «Дополнительные параметры».<br/>
                    Кроме того, отдельную группу товаров для экспорта можно выбрать вручную в разделе «<a href="?action=products" target="_blank">Товары</a>» и создать для них отдельный профиль экспорта.</p>
            </div>
        </div>

        <div class="field">
            <div class="name">Минимальная цена</div>
            <div class="value">
                <input type="text" name="export[min_price]" value="{$export.min_price|default:''|escape}"
                       placeholder="0.5" class="numerical shorter"
                       id="s-plugin-yandexmarket-export-min_price">{$primary_currency|escape}<br>

                <p class="hint">Товары с ценой меньше указанной не будут экспортированы в YML-файл</p>
            </div>
        </div>

        <div class="field">
            <div class="name">Остатки</div>
            <div class="value "><label for="s-plugin-yandexmarket-export-zero-stock">
                    <input name="export[zero_stock]" id="s-plugin-yandexmarket-export-zero-stock" type="checkbox" value="1"{if !empty($export.zero_stock)} checked="checked" {/if}> Выгружать товары с нулевым остатком
                </label>
                <br/><span class="hint">Товары с нулевым остатком экспортируются как доступные на заказ.</span>
            </div>
        </div>
{*END*}
        <div class="field">
            <div class="name">Скидки</div>
            <div class="value ">
                <label for="s-plugin-yandexmarket-export-compare-price">
                    <input name="export[compare_price]" id="s-plugin-yandexmarket-export-compare-price" type="checkbox" value="1"{if !empty($export.compare_price)} checked="checked" {/if}> Экспортировать зачеркнутую цену в параметр <tt>&lt;oldprice&gt;</tt> для расчета скидки на товар
                </label>
                <p class="hint">По правилам «Яндекс.Маркета» скидка должна быть не ниже 5% и не выше 95%.</p>
            </div>
        </div>

        <div class="field">
            <div class="name">
                Артикулы
            </div>
            <div class="value ">
                <label for="s-plugin-yandexmarket-export-sku">
                    <input name="export[sku]" id="s-plugin-yandexmarket-export-sku" type="checkbox" value="1"{if !empty($export.sku)} checked="checked" {/if}> Экспортировать каждый артикул товара как отдельную позицию
                </label>
                <p class="hint"> Каждый артикул будет экспортирован как отдельное товарное предложение. Значения для полей «<em>наименование</em>» и «<em>количество</em>» будут получены из соответствующих свойств артикулов.</p>
            </div>
        </div>

        <div class="field">
            <div class="name">
                Группировка артикулов
                <br>
                <span class="hint">Используется только для типа экспорта «<em>Произвольный товар (vendor.model)</em>»</span>
            </div>
            <div class="value ">
                <label for="s-plugin-yandexmarket-export-sku-group-none">
                    <input name="export[sku_group]" id="s-plugin-yandexmarket-export-sku-group-none" type="radio" value=""{if empty($export.sku_group)} checked="checked" {/if}> Не группировать артикулы
                </label>
                <span class="hint"><br>Каждый артикул будет экспортирован как отдельная товарная позиция на «Яндекс.Маркете».</span>
            </div>
            <div class="value ">
                <label for="s-plugin-yandexmarket-export-sku-group-all">
                    <input name="export[sku_group]" id="s-plugin-yandexmarket-export-sku-group-all" type="radio" value="all"{if ifset($export.sku_group)=='all'} checked="checked" {/if}> Группировать все артикулы
                </label>
                <span class="hint"><br>Все артикулы товара будут объединены в одну товарную позицию на «Яндекс.Маркете».</span>
            </div>

            <div class="value ">
                <label for="s-plugin-yandexmarket-export-sku-group-category">
                    <input name="export[sku_group]" id="s-plugin-yandexmarket-export-sku-group-category" type="radio" value="category"{if ifset($export.sku_group)=='category'} checked="checked" {/if}> Группировать на основе настройки основной категории товара
                </label>
                <span class="hint"><br>Все артикулы товара будут объединены в одну товарную позицию на «Яндекс.Маркете», только если для основной категории этого товара включена опция «<em>Группировка товарных предложений</em>» (настраивается отдельно в свойствах каждой категории товаров).</span>
            </div>
        </div>

        <div class="field">
            <div class="name">Закупочная цена</div>
            <div class="value ">
                <label for="s-plugin-yandexmarket-export-purchase-price">
                    <input name="export[purchase_price]" id="s-plugin-yandexmarket-export-purchase-price" type="checkbox" value="1"{if !empty($export.purchase_price)} checked="checked" {/if}> Экспортировать закупочную цену в параметр <tt>&lt;purchase_price&gt;</tt>
                </label>
            </div>
        </div>

        <div class="field">
            <div class="name">Скрытые категории</div>
            <div class="value "><label for="s-plugin-yandexmarket-export-hidden-categories">
                    <input name="export[hidden_categories]" id="s-plugin-yandexmarket-export-hidden-categories" type="checkbox" value="1"{if !empty($export.hidden_categories)} checked="checked" {/if} > Выгружать скрытые категории
                </label>
                <p class="hint">Скрытые категории будут экспортированы без своих URL — только для классификации товаров. Также будут экспортированы товары, принадлежащие к скрытым категориям (полезно для случаев, когда такие товары доступны на витрине через динамические категории).</p>
            </div>
        </div>

        <div class="field">
            <div class="name">Товары для взрослых</div>
            <div class="value ">
                <select name="shop[adult]" id="s-plugin-yandexmarket-shop-adult">
                    <option value=""></option>
                    <option value="true"{if ifempty($profile.config.shop.adult) eq 'true'} selected="selected"{/if}>Да</option>
                    <option value="false"{if ifempty($profile.config.shop.adult) eq 'false'} selected="selected"{/if}>Нет</option>
                </select>
            </div>
        </div>
    </div>

    <div class="field-group  ">
        <h2>4. Общие параметры доставки</h2>

        <div class="field">
            <div class="name">
                Покупка в офлайне
            </div>
            <div class="value ">
                <select name="shop[store]" id="s-plugin-yandexmarket-shop-store">
                    <option value=""></option>
                    <option value="true"{if ifempty($profile.config.shop.store) eq 'true'} selected="selected"{/if}>Да</option>
                    <option value="false"{if ifempty($profile.config.shop.store) eq 'false'} selected="selected"{/if}>Нет</option>
                </select>

                <p class="hint">Возможность приобрести товар в точке продаж без предварительного заказа через интернет
                <br/>{$_info_icon}
                Это значение может быть переопределено для отдельных товаров в секции «Экспорт характеристик товаров».</p>
            </div>
        </div>

        <div class="field">
            <div class="name">
                Самовывоз
            </div>
            <div class="value ">
                <select name="shop[pickup]" id="s-plugin-yandexmarket-shop-pickup">
                    <option value=""></option>
                    <option value="true"{if ifempty($profile.config.shop.pickup) eq 'true'} selected="selected"{/if}>Да</option>
                    <option value="false"{if ifempty($profile.config.shop.pickup) eq 'false'} selected="selected"{/if}>Нет</option>
                </select>

                <p class="hint">Возможность предварительно заказать товар и забрать его в точке продаж
                <br/>{$_info_icon}
                Это значение может быть переопределено для отдельных товаров в секции «Экспорт характеристик товаров».</p>
            </div>
        </div>

        <div class="field">
            <div class="name">
                Доставка
            </div>
            <div class="value ">
                <select name="shop[delivery]" id="s-plugin-yandexmarket-shop-delivery">
                    <option value=""></option>
                    <option value="true"{if ifempty($profile.config.shop.delivery) eq 'true'} selected="selected"{/if}>Да</option>
                    <option value="false"{if ifempty($profile.config.shop.delivery) eq 'false'} selected="selected"{/if}>Нет</option>
                </select>

                <p class="hint">
                    Осуществляет ли ваш магазин доставку<br/>
                    {$_info_icon}
                    Это значение может быть переопределено для отдельных товаров в секции «Экспорт характеристик товаров».
                </p>
            </div>
        </div>

        <div class="field js-local-delivery-cost">
            <div class="name">
                Стоимость доставки
            </div>
            <div class="value">
                <input type="text" name="shop[local_delivery_cost]" value="{ifset($profile.config.shop.local_delivery_cost)|escape}" placeholder="0" class="numerical shorter" id="s-plugin-yandexmarket-shop-local_delivery_cost"> {$primary_currency|escape}&rarr;&lt;delivery-options&gt;&lt;option <b>cost</b>="..." &gt;

                <p class="hint">
                    {$_info_icon}
                    Это значение может быть переопределено для отдельных товаров в секции «Экспорт характеристик товаров».
                </p>
            </div>
        </div>

        <div class="field js-local-delivery-estimate">
            <div class="name">
                Сроки доставки
            </div>
            <div class="value">
                <input type="text" name="shop[local_delivery_estimate]" value="{ifset($profile.config.shop.local_delivery_estimate)|escape}" placeholder="2-4" class="numerical shorter" id="s-plugin-yandexmarket-shop-local_delivery_estimate">&rarr;&lt;delivery-options&gt;&lt;option <b>days</b>="..." &gt;

                <p class="hint">
                    Срок указывается в рабочих днях<br/>
                    {$_info_icon}
                    Это значение может быть переопределено для отдельных товаров в секции «Экспорт характеристик товаров».
                </p>
            </div>
        </div>

        <div class="field js-local-delivery-order-before">
            <div class="name">
                Время приема заказа
            </div>
            <div class="value">
                {$profile.config.shop.local_delivery_order_before=min(24,max(1,intval(ifset($profile.config.shop.local_delivery_order_before,24))))}
                <input type="text" name="shop[local_delivery_order_before]" value="{$profile.config.shop.local_delivery_order_before|escape}" placeholder="24" class="numerical shorter" id="s-plugin-yandexmarket-shop-local_delivery_order_before">&rarr;&lt;delivery-options&gt;&lt;option <b>order-before</b>="..." &gt;

                <p class="hint">
                    Время оформления заказа (только часы), до наступления которого действуют указанные сроки и условия доставки.<br/>
                    {$_info_icon}
                    Это значение может быть переопределено для отдельных товаров в секции «Экспорт характеристик товаров».
                </p>
            </div>
        </div>
    </div>

    <div class="field-group  ">
        <h2>5. Экспорт характеристик товаров</h2>
        <div class="custom-mb-24">
            <p class="hint">Базовое соответствие характеристик магазина параметрам товарных предложений «Яндекс.Маркета». Для отдельных групп товарных предложений «Яндекс.Маркета» можно ниже задать дополнительные правила соответствий.</p>
            {if !empty($custom_map)}
                <p class="hint">
                    <i class="fas fa-exclamation-triangle"></i> Загружен пользовательский файл настроек полей экспорта <em>wa-config/apps/shop/plugins/yandexmarket/map.php</em>.<br>
                    Чтобы использовать оригинальный файл настроек, удалите пользовательский файл.
                </p>
            {/if}
        </div>
        {$type_info = $type_map.simple}
        {$map=$type_info.fields}
        {$type_id='simple'}
        {$js_base_href="#/yandexmarket:`$profile.id`"}
        {$_params=false}
        {foreach $map as $field => $info}
            {if (ifempty($info.type) eq 'adjustable')}
                {if $field=='param.*'}
                    {$field='param.${id}'}
                    {$_params=true}
                <!-- jquery template {capture name="yandexmarket-`$type_id`-template-js"} -->
                {include file="./mapField.html" inline}
                <!-- {/capture} placeholder -->
                {else}
                    {include file="./mapField.html" inline}
                {/if}
            {elseif !empty($info.available_options)}
                {include file="./mapField.html" inline}
            {/if}
        {/foreach}

        {if $_params}
        <div class="custom-mt-8 custom-mb-24 field">
            <div class="value submit">
                <a href="{$js_base_href|default:'#'}/param/add/{$type_id}/" class="inline-link js-action small">
                    <i class="fas fa-plus-circle text-green"></i>&nbsp;Добавить характеристику <tt>&lt;param&gt;</tt>
                </a>
            </div>
        </div>
        {/if}

        {foreach $type_map as $type_id =>$type_info}
            {if $type_id neq 'simple'}
                {$map=$type_info.fields}
                {$_params=false}
                <div class="field-group custom-m-0 custom-py-8">
                    <h5><label>{*3.{$type_info@iteration-1}. *}<input type="checkbox" class="js-types custom-mt-0" value="{$type_id}"{if !empty($types_map[$type_id])} checked="checked"{/if}> {$type_info.name|escape}</label></h5>

                    <div class="field">
                        <div class="name">Типы товаров, относящиеся к этой группе товарных предложений «Яндекс.Маркета»</div>
                        <div class="value">
                            <ul class="menu">
                                {foreach $types as $type}{if $type.count}
                                    <li class="bottom-padded">
                                        <label class="flexbox middle space-8">
                                            <span class="icon text-gray">{$wa->shop->getIcon($type.icon)}</span>
                                            <span><input class="js-type-map custom-mt-0" type="checkbox" name="types[{$type_id}][]" value="{$type.id}" {if !empty($types_map[$type_id]) && in_array($type.id,$types_map[$type_id])} checked="checked"{/if}></span>
                                            <span>{$type.name|escape}</span>
                                        </label>
                                    </li>
                                {/if}{/foreach}
                            </ul>
                        </div>
                    </div>
                    {foreach $map as $field => $info}
                        {if (ifempty($info.type) eq 'adjustable')}
                            {if $field=='param.*'}
                                {$_params=true}
                                {$field='param.${id}'}
                                <!-- jquery template {capture name="yandexmarket-`$type_id`-template-js"} -->
                                {include file="./mapField.html" inline}
                                <!-- {/capture} placeholder -->
                            {else}
                                {include file="./mapField.html" inline}
                            {/if}
                        {/if}
                    {/foreach}
                    {if $_params}
                        <div class="custom-mt-8 field">
                            <div class="value submit">
                                <a href="{$js_base_href|default:'#'}/param/add/{$type_id}/" class="inline-link js-action small">
                                    <i class="fas fa-plus-circle text-green"></i> Добавить характеристику <tt>&lt;param&gt;</tt>
                                </a>
                            </div>
                        </div>
                    {/if}
                </div>
            {/if}
        {/foreach}
    </div>

    <section class="field-group ymarket-promos-section">
        <h2>6. Промоакции</h2>
        <p class="hint">Информация о промоакциях появляется из 2 источников: из Shop-Script и из специальных плагинов. Описание экспорта промоакций и список подходящих плагинов смотрите в <a href="https://support.webasyst.ru/shop-script/276/shop-script-yandexmarket/#promo" target="_blank">инструкции</a>. Включите доступные промоакции в списке ниже.</p>
        {if !isset($promo_rules)}
            <p><i class="fas fa-times-circle text-red"></i>&nbsp;Текущая версия Shop-Script не поддерживает промоакции.</p>
        {elseif empty($promo_rules)}
            <p><i class="fas fa-exclamation-triangle text-yellow"></i>&nbsp;Нет доступных промоакций.</p>
        {else}

            {$_flash_discount = []}
            {$_gift = []}
            {$_promo_code = []}
            {$_n_plus_m = []}
            {foreach $promo_rules as $id =>  $promo}
                {if $promo.type eq shopImportExportHelper::PROMO_TYPE_FLASH_DISCOUNT}
                    {capture append="_flash_discount"}{include file="./promoRule.html" inline}{/capture}
                {/if}
                {if $promo.type eq shopImportExportHelper::PROMO_TYPE_GIFT}
                    {capture append="_gift"}{include file="./promoRule.html" inline}{/capture}
                {/if}
                {if $promo.type eq shopImportExportHelper::PROMO_TYPE_PROMO_CODE}
                    {capture append="_promo_code"}{include file="./promoRule.html" promo_name="`$promo.promo_code`" inline}{/capture}
                {/if}
                {if $promo.type eq shopImportExportHelper::PROMO_TYPE_N_PLUS_M}
                    {capture append="_n_plus_m"}{include file="./promoRule.html" inline}{/capture}
                {/if}
            {/foreach}

            <div class="field s-promo-section">
                <div class="name">Специальная цена</div>
                <div class="value">
                    {if !empty($_flash_discount)}
                        <table class="zebra">{$_flash_discount|join:""}</table>
                    {else}
                        <p>Промоакции со специальными ценами не найдены.</p>
                        <p class="hint">Для работы акций типа «Специальная цена» нужно установить и настроить плагин, который обеспечивает такую функциональность.</p>
                    {/if}
                </div>
            </div>

            <div class="field s-promo-section">
                <div class="name">Подарки</div>
                <div class="value">
                    {if !empty($_gift)}
                        <table class="zebra">{$_gift|join:""}</table>
                    {else}
                        <p>Промоакции с подарками не найдены.</p>
                        <p class="hint">Для работы акций типа «Подарок» нужно установить и настроить плагин, который обеспечивает такую функциональность.</p>
                    {/if}
                </div>
            </div>

            <div class="field s-promo-section">
                <div class="name">Промокоды</div>
                <div class="value">
                    {if !empty($_promo_code)}
                        <table class="zebra">{$_promo_code|join:""}</table>
                    {else}
                        <p>Промоакции с промокодами не найдены.</p>
                        <p class="hint">Для работы акций типа «Подарок» нужно установить и настроить плагин, который обеспечивает такую функциональность, или настроить купоны на скидку.</p>
                    {/if}
                </div>
            </div>

            <div class="field s-promo-section">
                <div class="name">
                    <div style="margin: 0 0 .5em;">N + M</div>
                    <p class="hint">При покупке N товаров M таких же товаров бесплатно.</p>
                </div>
                <div class="value">
                    {if !empty($_n_plus_m)}
                        <table class="zebra">{$_n_plus_m|join:""}</table>
                    {else}
                        <p>Промоакции типа «N + M» не найдены.</p>
                        <p class="hint">Для работы акций типа «N + M» нужно установить и настроить плагин, который обеспечивает такую функциональность.</p>
                    {/if}
                </div>
            </div>
        {/if}
    </section>
    <div class="clear-left"></div>

    <div class="field js-currency-warning" {if !$error_currency}style="display:none;"{/if}>
        {$currency_warning}
    </div>

    <div class="custom-m-24" id="plugin-yandexmarket-submit">
        <div class="field">
            <div class="submit">
                <input type="submit" class="button green" value="Сохранить и экспортировать">
                <div class="custom-mt-12 js-profile-notice italic small">Изменения в настройках сохранятся во время экспорта и будут автоматически применены к последующим сессиям экспорта с использованием этого профиля.</div>
                <div class="js-progressbar-container" style="display:none;">
                    <div class="progressbar blue" style="display: none; width: 70%;">
                        <div class="progressbar-outer">
                            <div class="progressbar-inner" style="width: 0;"></div>
                        </div>
                    </div>
                    <img style="float:left; margin-top:8px; margin-right: 16px; margin-bottom: 20px;" src="{$wa_url}wa-content/img/loading32.gif"/>
                    <span class="progressbar" id="progressbar-load"></span>
                    <div class="clear"></div>
                    <span class="progressbar-description"></span>
                    <div class="custom-mt-12 small italic state-caution">
                        Не закрывайте окно браузера и не покидайте страницу до тех пор, пока процесс экспорта не будет завершен.
                    </div>
                </div>
                <em class="state-error-hint"></em>
            </div>
        </div>
    </div>
    <div class="custom-m-24" id="plugin-yandexmarket-report" style="display: none;">
        <div class="field vertical">
            <div class="submit"></div>
            <div class="submit"><a href="#/yandexmarket{if !empty($profile.id)}:{$profile.id}{/if}/" name="/yandexmarket/" onclick="$.importexport.plugins.yandexmarket.getLink();" class="bold">Получить ссылку на файл</a></div>
        </div>
    </div>
    </div>
    </form>
{else}
    <p>
    <span class="state-error-hint">Не найдено ни одной витрины интернет-магазина.</span>
        Необходимо создать хотя бы одно поселение (витрину) магазина для правильного формирования адресов страниц товаров в YML-файле для «Яндекс.Маркета».
    </p>
{/if}
</div>

<div class="clear"></div>

{/strip}

<script>
    if ($.importexport.plugins.yandexmarket) {
        $.importexport.plugins.yandexmarket.init({$params|json_encode});

    } else {
        $.getScript('{$wa_app_static_url}plugins/yandexmarket/js/yandexmarket.js', function () {
            $.importexport.plugins.yandexmarket.init({$params|json_encode});
        });
    }

    {* generic code for plugins with profiles support *}
    $.importexport.profiles.set('yandexmarket',{$profiles|json_encode});

    {* Smart loader for sources *}
    (function ($) {

        load([
            {
                id: "wa-plugin-yandexmarket-css",
                type: "css",
                uri: "{$wa_app_static_url}plugins/yandexmarket/css/yandexmarket.css?" + Date.now()
            }
        ]).then();

        function load(sources) {
            var deferred = $.Deferred();

            loader(sources).then(function () {
                deferred.resolve();
            }, function (bad_sources) {
                if (console && console.error) {
                    console.error("Error loading resource", bad_sources);
                }
                deferred.reject(bad_sources);
            });

            return deferred.promise();

            function loader(sources) {
                var deferred = $.Deferred(),
                    counter = sources.length;

                var bad_sources = [];

                $.each(sources, function (i, source) {
                    switch (source.type) {
                        case "css":
                            loadCSS(source).then(onLoad, onError);
                            break;
                        case "js":
                            loadJS(source).then(onLoad, onError);
                            break;
                    }
                });

                return deferred.promise();

                function loadCSS(source) {
                    var deferred = $.Deferred(),
                        promise = deferred.promise();

                    var $link = $("#" + source.id);
                    if ($link.length) {
                        promise = $link.data("promise");

                    } else {
                        $link = $("<link />", {
                            id: source.id,
                            rel: "stylesheet"
                        }).appendTo("head")
                            .data("promise", promise);

                        $link
                            .on("load", function () {
                                deferred.resolve(source);
                            }).on("error", function () {
                            deferred.reject(source);
                        });

                        $link.attr("href", source.uri);
                    }

                    return promise;
                }

                function loadJS(source) {
                    var deferred = $.Deferred(),
                        promise = deferred.promise();

                    var $script = $("#" + source.id);
                    if ($script.length) {
                        promise = $script.data("promise");

                    } else {
                        var script = document.createElement("script");
                        document.getElementsByTagName("head")[0].appendChild(script);

                        $script = $(script)
                            .attr("id", source.id)
                            .data("promise", promise);

                        $script
                            .on("load", function () {
                                deferred.resolve(source);
                            }).on("error", function () {
                            deferred.reject(source);
                        });

                        $script.attr("src", source.uri);
                    }

                    return promise;
                }

                function onLoad(source) {
                    counter -= 1;
                    watcher();
                }

                function onError(source) {
                    bad_sources.push(source);
                    counter -= 1;
                    watcher();
                }

                function watcher() {
                    if (counter === 0) {
                        if (!bad_sources.length) {
                            deferred.resolve();
                        } else {
                            deferred.reject(bad_sources);
                        }
                    }
                }
            }
        }

        $(".wa-tooltip").waTooltip({
            allowHTML: true,
            delay: 300,
            interactive: true
        });
    })(jQuery);
</script>

{foreach $smarty.capture as $name => $template}
    {if strpos($name,'template-js')}
        <!-- begin {$name} -->
        <script type="text/x-jquery-tmpl" id="{$name}">{$template|regex_replace:'@(^.*-->)|(<!\-\-.*$)@m':''|replace:'</':'<\/'}</script>
        <!-- end {$name} -->
    {/if}
{/foreach}
