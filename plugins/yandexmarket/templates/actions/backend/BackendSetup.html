{strip}
<div class="block double-padded" id="s-yandexmarket-form">
    <p>Экспорт каталога товаров в формате YML, прием заказов (CPC, CPA)</p>
    <div class="block">
        <a href="https://www.shop-script.ru/help/276/shop-script-5-yandexmarket/" target="_blank" class="underline">
            <i class="icon16 light-bulb" style="vertical-align: middle;"></i>
            Документация пользователя
        </a> <i class="icon16 new-window"></i>
        <br/><br/>
        Для изменения дополнительных параметров экспорта и подключения к «Заказу на Маркете» (CPA) перейдите в <a href="?action=plugins#/yandexmarket/" class="underline bold">настройки плагина</a>.
    </div>
{if $settlements}
    <form id="s-plugin-yandexmarket" method="post" action="?plugin=yandexmarket&module=run">
    <div class="fields form">

        {if $info.exists}
            <div class="field-group block" style="border-bottom: 1px solid #ccc;">
                <div class="field">
                    <div class="name bold">
                        YML-файл
                    </div>
                    <div class="value">
                        <input id="s-plugin-yandexmarket-last-export" type="text" value="{$info.url|escape}" readonly="readonly" class="long bold large" style="width: 75% !important;">
                        <a href="{$info.url}?download=1" class="bold nowrap inline"><i class="icon16 download no-overhanging" style="margin-top: 0.4em;"></i>Скачать</a>
                        <p class="small">Файл обновлен: {$info.mtime|wa_datetime:"humandatetime"}</p>
                        <p class="small"><i class="icon10 yes"></i> Ссылка на YML-файл постоянна для этого профиля и не изменяется при повторном экспорте товаров.<br>
                        Чтобы сделать ссылку недействительной, удалите профиль.</p>
                    </div>
                    <div class="value">
                        <p><i class="icon16 info"></i>Команда CRON для автоматического обновления файла:</p>
                        <pre>{$cron_command|escape}</pre>
                    </div>
                </div>
            </div>
        {/if}
        <div class="field-group block">
            <div class="field js-profile-description">
                <div class="name">Название профиля</div>
                <div class="value">
                    <input type="text" name="profile[name]" value="{$profile.name|default:''|escape}" placeholder="Название профиля" id="s-plugin-yandexmarket-profile-name">
                    <input type="hidden" name="profile[id]" value="{$profile.id|default:'-1'}">
                </div>

            </div>

            <div class="field">
                <div class="name">
                    Обновление файла
                </div>
                <div class="value no-shift">
                    <select name="lifetime" id="s-plugin-yandexmarket-ondemand-update">
                        <option value="0"{if $profile.config.lifetime ==0} selected="selected"{/if}>Обновление только вручную</option>
                        <option value="60"{if $profile.config.lifetime ==60} selected="selected"{/if}>Автоматически при каждом запросе</option>
                        <option value="3600"{if $profile.config.lifetime ==3600} selected="selected"{/if}>Автоматически, но не чаще чем раз в час</option>
                        <option value="86400"{if $profile.config.lifetime ==86400} selected="selected"{/if}>Автоматически, но не чаще чем раз в день</option>
                        <option value="604800"{if $profile.config.lifetime ==604800} selected="selected"{/if}>Автоматически, но не чаще чем раз в неделю</option>
                    </select>
                    <p class="hint">Включите <em>автоматический экспорт</em> товаров, и YML-файл будет обновляться каждый раз при запросе его URL, если возраст файла больше выбранного значения.<br>
                    Если автоматическое обновление не выбрано, то по адресу файла будет доступна его последняя версия, экспортированная вручную.</p>
                </div>

                <div class="value no-shift">
                    <label>
                        <input name="force_update" id="s-plugin-yandexmarket-force-update" type="checkbox" value="1"{if !empty($profile.config.force_update)} checked="checked"{/if}> Обновлять файл, даже если в выгрузку не попадает ни одного товарного предложения
                    </label>
                </div>


            </div>
        </div>

        <div class="field-group block top-padded">
            <h2 class="gray">1. Данные магазина</h2>
            <div class="field">
                <div class="name">Название магазина</div>
                <div class="value">
                    <input name="company_name" placeholder="Название" value="{$company_name|escape}" id="s-plugin-yandexmarket-company-name" class="long">&rarr;&lt;name&gt;<br>

                    <p class="hint">Короткое название магазина — название, которое выводится в списке товаров, найденных на «Яндекс.Маркете».</p>
                </div>
            </div>

            <div class="field">
                <div class="name">Компания</div>
                <div class="value">
                    <input name="company" placeholder="Компания" value="{$company|escape}" id="s-plugin-yandexmarket-company" class="long">&rarr;&lt;company&gt;<br>

                    <p class="hint">Полное наименование компании, владеющей магазином. Не публикуется, используется для внутренней идентификации.</p>
                </div>
            </div>

            <div class="field">
                <div class="name">Номер телефона</div>
                <div class="value">
                    <input name="company_phone" placeholder="{$default_phone|escape}" value="{$company_phone|escape}" id="s-plugin-yandexmarket-phone" class="long">&rarr;&lt;phone&gt;<br>
                    <p class="hint">Если оставить это поле пустым, будет экспортирован телефонный номер из «<a href="?action=settings">Общих настроек</a>».<br>
                        Если нужно, впишите другой номер для этого профиля экспорта.</p>
                </div>
            </div>
        </div>

        <div class="field-group block top-padded">
            <h2 class="gray">2. Настройки URL</h2>

            <div class="field">
                <div class="name">
                    Витрина
                </div>
                {if count($settlements)>1}
                    <div class="value no-shift">
                        <select name="domain" id="s-plugin-yandexmarket-domain">
                            {foreach $settlements as $route}
                                <option value="{$route|escape}"{if $route eq $current_domain} selected="selected"{/if}>{waIdna::dec($route)|escape}</option>
                            {/foreach}
                        </select>
                        <br/>
                        <span class="hint">Витрину необходимо указать для правильного формирования адресов страниц товаров в YML-файле и отбора товаров для экспорта.</span>
                    </div>
                {elseif reset($settlements)}
                    <div class="value no-shift">
                        {$route = reset($settlements)}
                        <input type="text" readonly="readonly" value="{$route|escape}" name="domain" id="s-plugin-yandexmarket-domain">
                        <br/>
                        <span class="hint">Витрину необходимо указать для правильного формирования адресов страниц товаров в YML-файле и отбора товаров для экспорта.</span>
                    </div>
                {else}
                    <span class="errormsg">Не удалось обнаружить витрину магазина. Проверьте настройки поселения магазина в разделе «Витрина».</span>
                {/if}
                <div class="value no-shift">
                    <p>
                        <label><input type="checkbox" name="ssl" value="1" {if !empty($profile.config.ssl)} checked="checked"{/if}> Формировать ссылки, используя адреса с <em>https://</em></label>
                    </p>
                </div>
            </div>
            <div class="field js-profile-description">
                <div class="name">UTM-метки</div>
                <div class="value no-shift">
                    Источник (utm_source):<br>
                    <input type="text" name="utm_source" placeholder="yandexmarket" value="{$profile.config.utm_source|default:''|escape}" >
                </div>
                <div class="value no-shift">
                    Канал (utm_medium):<br>
                    <input type="text" name="utm_medium" placeholder="cpc" value="{$profile.config.utm_medium|default:''|escape}" >
                </div>
                <div class="value no-shift">
                    Кампания (utm_campaign):<br>
                    <input type="text" name="utm_campaign" placeholder="{$profile.name|default:''|escape}" value="{$profile.config.utm_campaign|default:''|escape}" >
                </div>
                <div class="value">
                    <p class="hint">Ко всем адресам (URL), содержащимся в файле, будут автоматически добавлены UTM-метки, которые позволят средствам веб-аналитики отслеживать переходы посетителей сайта по этим адресам.  Если вы не используете UTM-метки, просто оставьте поля пустыми.</p>
                </div>
            </div>
            <div class="field js-profile-description">
                <div class="name">Дополнительные параметры в URL</div>
                <div class="value no-shift">
                    <textarea name="custom_url" placeholder="utm_my_param1=100500&extraparam=500100&my_var=%sku%" style="width:90%;">{$profile.config.custom_url|default:''|escape}</textarea>
                </div>
                <div class="value no-shift hint">
                    Ко всем адресам (URL), содержащимся в файле, будут автоматически добавлена строка, сформированная на основе шаблона параметров, разделенных символом <tt>&amp;</tt>.<br/>
                    <a class="inline-link js-cheatsheet" href="#">
                        <i class="icon16 cheatsheet"></i>
                        <b>
                            <i>Шпаргалка</i>
                        </b>
                        <i class="icon10 rarr no-overhanging"></i>
                    </a>
                </div>
                <div class="value no-shift js-cheatsheet" style="display: none;">
                    Возможные переменные для использования в шаблоне:
                    <ul class="menu-v">
                        <li><b>%id%</b> — id товара</li>
                        <li><b>%sku%</b> — артикул товара</li>
                        <li><b>%name%</b> — название товара</li>
                        <li><b>%contact_id%</b> — id контакта, создавшего товар</li>
                        <li><b>%badge%</b> — значок на товаре</li>
                    </ul>
                    <b>Примеры:</b><br/>
                    utm_term=%id% (для PriceLab дополнительно заполните поле utm_source)<br/>
                    promo_id=1234 (для указания реферальной ссылки)

                </div>
            </div>
        </div>

        <div class="clear-left"></div>
    <div class="field-group block top-padded">
        <h2 class="gray">3. Экспорт товаров</h2>
        {$hash = $profile.config.hash}
{*BEGIN*}

        {*
@var array $set array of available sets
@var array $types array of available product types
@var array $hint array of hash hints
@var string $hash
*}
        {if true}
            {include file="../../../../../templates/includes/productSelector.html"}
            <div class="field">
                <div class="value">
                    <div class="clear-left"></div>
                    <p class="hint"><i class="icon10 exclamation"></i> Если товар не принадлежит ни к одной категории, то он не будет экспортирован в YML-файл.</p>
                </div>


                <div class="value">
                    <label><input type="checkbox" name="trace" value="1"{if !empty($trace)} checked="checked"{/if}>&nbsp;<span class="hint">Логировать предложения, не попавшие в выгрузку, в файл <tt>wa-log/shop/plugins/yandexmarket/export.trace.{$profile.id}
                                .log</tt>.</span></label>
                </div>
            </div>
        {else}
        <div class="field">
            <div class="name">
                {_wd('shop',"Select products")}
            </div>
            {$hash = shopImportexportHelper::parseHash($hash)}
            <div class="value">
                <div class="sidebar left200px">
                    <ul class="menu-v">
                        <li>
                            <label class="black"><input type="radio" value="" name="hash"{if empty($hash.type)} checked="checked"{/if}> {_wd('shop',"All products")}</label>
                        </li>
                        <li{if $hash.type neq 'id'} style="display: none;"{/if}>
                            <label class="black"><input type="radio" value="id" name="hash"{if $hash.type eq 'id'} checked="checked"{/if}>
                                <input type="hidden" value="{$hash.product_ids|default:''}" name="product_ids"> <span>{if $hash.type eq 'id'}{$hash.count|string_format:"{_wd('shop',"Selected products (%d)")}"}{else}{_wd('shop',"Selected products (%d)")}{/if}</span></label>
                        </li>
                        <li{if $hash.type neq 'category'} style="display: none;"{/if}>
                            <label class="black"><input type="radio" value="category" name="hash"{if $hash.type eq 'category'} checked="checked"{/if}>
                                <input type="hidden" value="{$hash.category_ids|default:''}" name="category_ids"> <span>{if $hash.type eq 'category'}{$hash.count|string_format:"{_wd('shop',"Selected categories (%d)")}"}{else}{_wd('shop',"Selected categories (%d)")}{/if}</span></label>
                        </li>
                        <li>
                            <label class="black"><input type="radio" value="set" name="hash"{if $hash.type eq 'set'} checked="checked"{/if}> {_wd('shop',"Sets")}</label>
                        </li>
                        <li>
                            <label class="black"><input type="radio" value="type" name="hash"{if $hash.type eq 'type'} checked="checked"{/if}> {_wd('shop',"Product types")}</label>
                        </li>
                    </ul>
                </div>
                <div class="value js-hash-values js-hash-set" style="width: 400px;">
                    <div class="bordered-left" style="padding-left: 20px; margin-left: 20px;">
                        <ul class="menu-v with-icons">
                            {foreach $sets as $set}
                                <li>
                                    <label title="{$set.id|escape}">
                                        <span class="count">{if !empty($set.type)}&le;{/if}{$set.count}</span>
                                        <i class="icon16 {if $set.type == shopSetModel::TYPE_DYNAMIC}funnel{else}ss set{/if}"></i>
                                        <input type="radio" name="set_id" value="{$set.id}"{if ($set@first && empty($hash.set_id))||($hash.set_id eq $set.id)} checked="checked"{/if}>
                                        {$set.name|escape}
                                    </label>
                                </li>
                            {/foreach}
                        </ul>
                        {if !empty($hints.set)}<br/><span class="gray">{$hints.set}</span>{/if}
                    </div>
                </div>
                <div class="value js-hash-values js-hash-type" style="width: 400px;">
                    <div class="bordered-left" style="padding-left: 20px; margin-left: 20px;">
                        <ul class="menu-v with-icons">
                            {foreach $types as $type}{if $type.count}
                                <li>
                                    <label>
                                        <span class="count">{$type.count}</span>
                                        {shopHelper::getIcon($type.icon)}
                                        <input type="radio" name="type_id" value="{$type.id}" {if ($type@first && empty($hash.type_id))||($hash.type_id eq $type.id)} checked="checked"{/if}> {$type.name|escape}
                                    </label>
                                </li>
                            {/if}{/foreach}
                        </ul>
                        {if !empty($hints.type)}<br/><span class="gray">{$hints.type}</span>{/if}
                    </div>
                </div>
                <div class="clear-left"></div>
                <p class="hint"><i class="icon10 exclamation"></i> Если товар не принадлежит ни к одной категории, то он не будет экспортирован в YML-файл.</p>
            </div>

    

            <div class="value">
                <label><input type="checkbox" name="trace" value="1"{if !empty($trace)} checked="checked"{/if}>&nbsp;<span class="hint">Логировать предложения, не попавшие в выгрузку, в файл <tt>wa-log/shop/plugins/yandexmarket/export.trace.{$profile.id}.log</tt>.</span></label>
            </div>
        </div>
        {/if}


        <div class="field">
            <div class="name">Фильтр</div>
            <div class="value no-shift">
                <label>
                    <input type="checkbox" name="export[skip_ignored]" value="1"
                           {if !empty($export.skip_ignored)}checked="checked"{/if}
                           id="s-plugin-yandexmarket-export-skip_ignored"> Товары, у которых в дополнительных параметрах указано значение <tt>yandexmarket.ignored=1</tt>, не будут экспортированы в YML-файл.
                </label>
                <p class="hint">Добавить дополнительный параметр возможно при редактировании товара, на вкладке «Описание и SEO», в поле «Дополнительные параметры».<br/>
                    Кроме того, отдельную группу товаров для экспорта можно выбрать вручную в разделе «<a href="?action=products" target="_blank">Товары</a>» и создать для них отдельный профиль экспорта.</p>
            </div>
        </div>

        <div class="field">
            <div class="name">Минимальная цена</div>
            <div class="value">
                <input type="text" name="export[min_price]" value="{$export.min_price|default:''|escape}"
                       placeholder="0.5" class="numerical short"
                       id="s-plugin-yandexmarket-export-min_price">{$primary_currency|escape}<br>

                <p class="hint">Товары с ценой меньше указанной не будут экспортированы в YML-файл</p>
            </div>
        </div>

        <div class="field">
            <div class="name">Остатки</div>
            <div class="value no-shift"><label for="s-plugin-yandexmarket-export-zero-stock">
                    <input name="export[zero_stock]" id="s-plugin-yandexmarket-export-zero-stock" type="checkbox" value="1"{if !empty($export.zero_stock)} checked="checked" {/if}> Выгружать товары с нулевым остатком
                </label>
                <br/><span class="hint">Товары с нулевым остатком экспортируются как доступные на заказ.</span>
            </div>
        </div>
{*END*}
        <div class="field">
            <div class="name">Скидки</div>
            <div class="value no-shift">
                <label for="s-plugin-yandexmarket-export-compare-price">
                    <input name="export[compare_price]" id="s-plugin-yandexmarket-export-compare-price" type="checkbox" value="1"{if !empty($export.compare_price)} checked="checked" {/if}> Экспортировать зачеркнутую цену в параметр <tt>&lt;oldprice&gt;</tt> для рассчета скидки на товар
                </label>
                <p class="hint">По правилам «Яндекс.Маркета» скидка должна быть не ниже 5% и не выше 95%.</p>
            </div>
        </div>

        <div class="field">
            <div class="name">
                Артикулы
            </div>
            <div class="value no-shift">
                <label for="s-plugin-yandexmarket-export-sku">
                    <input name="export[sku]" id="s-plugin-yandexmarket-export-sku" type="checkbox" value="1"{if !empty($export.sku)} checked="checked" {/if}> Экспортировать каждый артикул товара как отдельную позицию
                </label>
                <p class="hint"> Каждый артикул будет экспортирован как отдельное товарное предложение. Значения для полей «<em>наименование</em>» и «<em>количество</em>» будут получены из соответствующих свойств артикулов.</p>
            </div>
        </div>

        <div class="field">
            <div class="name">
                Группировка артикулов
                <br>
                <span class="hint">Используется только для типа экспорта «<em>Произвольный товар (vendor.model)</em>»</span>
            </div>
            <div class="value no-shift">
                <label for="s-plugin-yandexmarket-export-sku-group-none">
                    <input name="export[sku_group]" id="s-plugin-yandexmarket-export-sku-group-none" type="radio" value=""{if empty($export.sku_group)} checked="checked" {/if}> Не группировать артикулы
                </label>
                <span class="hint"><br>Каждый артикул будет экспортирован как отдельная товарная позиция на «Яндекс.Маркете».</span>
            </div>
            <div class="value no-shift">
                <label for="s-plugin-yandexmarket-export-sku-group-all">
                    <input name="export[sku_group]" id="s-plugin-yandexmarket-export-sku-group-all" type="radio" value="all"{if ifset($export.sku_group)=='all'} checked="checked" {/if}> Группировать все артикулы
                </label>
                <span class="hint"><br>Все артикулы товара будут объединены в одну товарную позицию на «Яндекс.Маркете».</span>
            </div>

            <div class="value no-shift">
                <label for="s-plugin-yandexmarket-export-sku-group-category">
                    <input name="export[sku_group]" id="s-plugin-yandexmarket-export-sku-group-category" type="radio" value="category"{if ifset($export.sku_group)=='category'} checked="checked" {/if}> Группировать на основе настройки основной категории товара
                </label>
                <span class="hint"><br>Все артикулы товара будут объединены в одну товарную позицию на «Яндекс.Маркете», только если для основной категории этого товара включена опция «<em>Группировка товарных предложений</em>» (настраивается отдельно в свойствах каждой категории товаров).</span>
            </div>
        </div>

        <div class="field">
            <div class="name">Закупочная цена</div>
            <div class="value no-shift">
                <label for="s-plugin-yandexmarket-export-purchase-price">
                    <input name="export[purchase_price]" id="s-plugin-yandexmarket-export-purchase-price" type="checkbox" value="1"{if !empty($export.purchase_price)} checked="checked" {/if}> Экспортировать закупочную цену в параметр <tt>&lt;purchase_price&gt;</tt>
                </label>
            </div>
        </div>

        <div class="field">
            <div class="name">Скрытые категории</div>
            <div class="value no-shift"><label for="s-plugin-yandexmarket-export-hidden-categories">
                    <input name="export[hidden_categories]" id="s-plugin-yandexmarket-export-hidden-categories" type="checkbox" value="1"{if !empty($export.hidden_categories)} checked="checked" {/if} > Выгружать скрытые категории
                </label>
                <p class="hint">Скрытые категории будут экспортированы без своих URL — только для классификации товаров. Также будут экспортированы товары, принадлежащие к скрытым категориям (полезно для случаев, когда такие товары доступны на витрине через динамические категории).</p>
            </div>
        </div>

        <div class="field">
            <div class="name">Товары для взрослых</div>
            <div class="value no-shift">
                <select name="shop[adult]" id="s-plugin-yandexmarket-shop-adult">
                    <option value=""></option>
                    <option value="true"{if ifempty($profile.config.shop.adult) eq 'true'} selected="selected"{/if}>Да</option>
                    <option value="false"{if ifempty($profile.config.shop.adult) eq 'false'} selected="selected"{/if}>Нет</option>
                </select>
            </div>
        </div>

        <div class="field">
            <div class="name">Участие предложений в программе «Заказ на Маркете».</div>
            <div class="value no-shift">
                <select name="shop[cpa]" id="s-plugin-yandexmarket-shop-cpa">
                    <option value=""></option>
                    <option value="true"{if ifempty($profile.config.shop.cpa) eq 'true'} selected="selected"{/if}>Да</option>
                    <option value="false"{if ifempty($profile.config.shop.cpa) eq 'false'} selected="selected"{/if}>Нет</option>
                </select>
                <br/>
                <span class="hint">Глобальный параметр <tt>cpa</tt> для для элемента <tt>&lt;shop&gt;</tt>.
                <br/>Обработка заказов возможна вручную в партнерском интерфейсе «Яндекс.Маркета» или автоматически через <a href="?action=plugins#/yandexmarket/api/">API в Shop-Script</a>.
                <br/><i class="icon10 info"></i>Это значение может быть переопределено для отдельных товаров в секции «Экспорт характеристик товаров».</span>
            </div>
        </div>
    </div>

    <div class="field-group block top-padded">
        <h2 class="gray">4. Общие параметры доставки</h2>
        <div class="field">
            <div class="name">
                Покупка в офлайне
            </div>
            <div class="value no-shift">
                <select name="shop[store]" id="s-plugin-yandexmarket-shop-store">
                    <option value=""></option>
                    <option value="true"{if ifempty($profile.config.shop.store) eq 'true'} selected="selected"{/if}>Да</option>
                    <option value="false"{if ifempty($profile.config.shop.store) eq 'false'} selected="selected"{/if}>Нет</option>
                </select>

                <p class="hint">Возможность приобрести товар в точке продаж без предварительного заказа через интернет
                <br/><i class="icon10 info"></i>Это значение может быть переопределено для отдельных товаров в секции «Экспорт характеристик товаров».</p>
            </div>
        </div>

        <div class="field">
            <div class="name">
                Самовывоз
            </div>
            <div class="value no-shift">
                <select name="shop[pickup]" id="s-plugin-yandexmarket-shop-pickup">
                    <option value=""></option>
                    <option value="true"{if ifempty($profile.config.shop.pickup) eq 'true'} selected="selected"{/if}>Да</option>
                    <option value="false"{if ifempty($profile.config.shop.pickup) eq 'false'} selected="selected"{/if}>Нет</option>
                </select>

                <p class="hint">Возможность предварительно заказать товар и забрать его в точке продаж
                <br/><i class="icon10 info"></i>Это значение может быть переопределено для отдельных товаров в секции «Экспорт характеристик товаров».</p>
            </div>
        </div>

        <div class="field">
            <div class="name">
                Доставка
            </div>
            <div class="value no-shift">
                <select name="shop[delivery]" id="s-plugin-yandexmarket-shop-delivery">
                    <option value=""></option>
                    <option value="true"{if ifempty($profile.config.shop.delivery) eq 'true'} selected="selected"{/if}>Да</option>
                    <option value="false"{if ifempty($profile.config.shop.delivery) eq 'false'} selected="selected"{/if}>Нет</option>
                </select>

                <p class="hint">Осуществляет ли ваш магазин доставку
                <br/><i class="icon10 info"></i>Это значение может быть переопределено для отдельных товаров в секции «Экспорт характеристик товаров».</p>
            </div>
        </div>


        <div class="field">
            <div class="name">
                Время приема заказа
            </div>

            <div class="value">
                {$profile.config.shop.local_delivery_order_before=min(24,max(1,intval(ifset($profile.config.shop.local_delivery_order_before,24))))}
                <input type="text" name="shop[local_delivery_order_before]" value="{$profile.config.shop.local_delivery_order_before|escape}" placeholder="24" class="numerical short" id="s-plugin-yandexmarket-shop-local_delivery_order_before">&rarr;&lt;delivery-options&gt;&lt;option <b>order-before</b>="..." &gt;
            </div>

            <div class="value">
                <span class="hint">Время оформления заказа (только часы), до наступления которого действуют указанные сроки и условия доставки.<br>
                Это общее значение можно переопределить для отдельных товаров в секции «Экспорт характеристик товаров».</span>
            </div>
        </div>

        <div class="field js-delivery-options">
            <div class="name">Домашний регион</div>
            {if $api_available}
                <div class="value no-shift">
                    <input type="hidden" name="home_region_id" value="{$profile.config.home_region_id|default:''|escape}">
                    {if !empty($address)}
                        <span class="js-home-region-name">{$address.value|trim:' ,'}</span> <a href="#/yandexmarket:{$profile.id|escape}/region/edit/" class="inline-link js-edit-region js-action"><b><i>Изменить</i></b></a>
                    {else}
                        <span class="js-home-region-name"><i class="icon16 exclamation"></i>
                        Не удалось определить домашний регион.</span> <a href="#/yandexmarket:{$profile.id|escape}/region/edit/" class="inline-link js-edit-region js-action"><b><i>Настроить</i></b></a>
                        <br/>
                        <span class="hint"><i class="icon10 info"></i>Выбор домашнего региона необходим для получения списка доступных способов доставки в секции «Условия доставки».
                            <br/>Домашний регион определится автоматически из настроек кампании в аккаунте «Яндекс.Маркета» после экспорта этого YML-файла, если URL этого YML-файла указан в настройках кампании.</span>
                    {/if}

                    {if !empty($address_error)}<br/><span class="red"><i class="icon16 no"></i>{$address_error|escape}</span>{/if}

                </div>
                {if !empty($profile.config.campaign_id)}
                <div class="value">
                    <input type="hidden" name="campaign_id" value="{$profile.config.campaign_id|escape}">
                    <span class="hint">Домашний регион определен на основе настроек личного кабинета на сайте «Яндекс.Маркета», используется для расчета стоимости доставки.</span>
                </div>
                {/if}
                <div class="value js-edit-region" style="display:none;">
                    <!-- changed region placeholder -->
                </div>

                <div class="value js-edit-region" style="display:none;">
                    <a href="#/yandexmarket:{$profile.id|escape}/region/apply/" class="js-action">Применить</a> или <a href="#/yandexmarket:{$profile.id|escape}/region/cancel/" class="js-action">отмена</a>
                </div>
            {else}
                <div class="value">
                    Проверьте настройки <a href="?action=plugins#/yandexmarket/api/" title="Магазин — Плагины — Яндекс.Маркет — Авторизация партнерского API">партнерского API</a>
                    <br>
                    <span class="hint">Домашний регион необходимо указывать только при участии в программе "Заказ на Маркете"</span>
                </div>
            {/if}
        </div>
    </div>

    <div class="block top-padded">
        <h2 class="gray">5. Условия доставки (домашний регион)</h2>

        <div class="field">
            <div class="name">Доставка включена</div>
            <div class="value no-shift">
                <label><input type="checkbox" name="shop[deliveryIncluded]" value="true"{if ifempty($profile.config.shop.deliveryIncluded) eq 'true'} checked="checked"{/if}> Доставка уже включена в стоимость товара</label>
            </div>
        </div>
    </div>

    <div class="field-group block js-delivery-options">

        {include file="./BackendShipping.html"}

    </div>

    <div class="field-group block top-padded">
        <h2 class="gray">6. Экспорт характеристик товаров</h2>
        <p class="hint">Базовое соответствие характеристик магазина параметрам товарных предложений «Яндекс.Маркета». Для отдельных групп товарных предложений «Яндекс.Маркета» можно ниже задать дополнительные правила соответствий.</p>
        {if !empty($custom_map)}
            <p class="hint">
                <i class="icon16 exclamation"></i> Загружен пользовательский файл настроек полей экспорта <em>wa-config/apps/shop/plugins/yandexmarket/map.php</em>.<br>
                Чтобы использовать оригинальный файл настроек, удалите пользовательский файл.
            </p>
        {/if}
        {$type_info = $type_map.simple}
        {$map=$type_info.fields}
        {$type_id='simple'}
        {$js_base_href="#/yandexmarket:`$profile.id`"}
        {$_params=false}
        {foreach $map as $field => $info}
            {if (ifempty($info.type) eq 'adjustable')}
                {if $field=='param.*'}
                    {$field='param.${id}'}
                    {$_params=true}
                <!-- jquery template {capture name="yandexmarket-`$type_id`-template-js"} -->
                {include file="./mapField.html" inline}
                <!-- {/capture} placeholder -->
                {else}
                    {include file="./mapField.html" inline}
                {/if}
            {/if}
        {/foreach}

        {if $_params}
        <div class="field">
            <div class="value">
                <a href="{$js_base_href|default:'#'}/param/add/{$type_id}/" class="inline-link js-action small">
                    <i class="icon10 add"></i> Добавить характеристику <tt>&lt;param&gt;</tt>
                </a>
            </div>
        </div>
        {/if}

        {foreach $type_map as $type_id =>$type_info}
            {if $type_id neq 'simple'}
                {$map=$type_info.fields}
                {$_params=false}
                <div class="field-group" style="margin-top: 30px;">
                    <h3 class="gray"><label>{*3.{$type_info@iteration-1}. *}<input type="checkbox" class="js-types" value="{$type_id}"{if !empty($types_map[$type_id])} checked="checked"{/if}> {$type_info.name|escape}</label></h3>

                    <div class="field">
                        <div class="name">Типы товаров, относящиеся к этой группе товарных предложений «Яндекс.Маркета»</div>
                        <div class="value">
                            <ul class="menu-v with-icons">
                                {foreach $types as $type}{if $type.count}
                                    <li>
                                        <label>
                                            {shopHelper::getIcon($type.icon)}
                                            <input class="js-type-map" type="checkbox" name="types[{$type_id}][]" value="{$type.id}" {if !empty($types_map[$type_id]) && in_array($type.id,$types_map[$type_id])} checked="checked"{/if}>
                                            &nbsp;{$type.name|escape}
                                        </label>
                                    </li>
                                {/if}{/foreach}
                            </ul>
                        </div>
                    </div>
                    {foreach $map as $field => $info}
                        {if (ifempty($info.type) eq 'adjustable')}
                            {if $field=='param.*'}
                                {$_params=true}
                                {$field='param.${id}'}
                                <!-- jquery template {capture name="yandexmarket-`$type_id`-template-js"} -->
                                {include file="./mapField.html" inline}
                                <!-- {/capture} placeholder -->
                            {else}
                                {include file="./mapField.html" inline}
                            {/if}
                        {/if}
                    {/foreach}
                    {if $_params}
                        <div class="field">
                            <div class="value">
                                <a href="{$js_base_href|default:'#'}/param/add/{$type_id}/" class="inline-link js-action small">
                                    <i class="icon10 add"></i> Добавить характеристику <tt>&lt;param&gt;</tt>
                                </a>
                            </div>
                        </div>
                    {/if}
                </div>
            {/if}
        {/foreach}
    </div>
    <div class="clear-left"></div>

    <div class="field-group" id="plugin-yandexmarket-submit">
        <div class="field">
            <div class="value submit">
                <input type="submit" class="button green" value="Сохранить и экспортировать">
                <br><br>
                <em class="small js-profile-notice">Изменения в настройках сохранятся во время экспорта и будут автоматически применены к последующим сессиям экспорта с использованием этого профиля.</em>

                <div class="js-progressbar-container" style="display:none;">
                    <div class="progressbar blue float-left" style="display: none; width: 70%;">
                        <div class="progressbar-outer">
                            <div class="progressbar-inner" style="width: 0;"></div>
                        </div>
                    </div>
                    <img style="float:left; margin-top:8px;" src="{$wa_url}wa-content/img/loading32.gif"/>

                    <div class="clear"></div>
                    <span class="progressbar-description"></span>
                    <br style="clear:left;"/>
                    <br>
                        <span class="small italic">
                            Не закрывайте окно браузера и не покидайте страницу до тех пор, пока процесс экспорта не будет завершен.
                        </span>
                </div>
                <br><br>
                <em class="errormsg"></em>
            </div>
        </div>
    </div>
    <div class="field-group" id="plugin-yandexmarket-report" style="display: none;">
        <div class="field">
            <div class="value"></div>
            <div class="value"><br><a href="#/yandexmarket{if !empty($profile.id)}:{$profile.id}{/if}/" name="/yandexmarket/" onclick="$.importexport.plugins.yandexmarket.getLink();" class="bold">Получить ссылку на файл</a></div>
        </div>
    </div>
    </div>
    </form>
{else}
    <p>
    <span class="errormsg">Не найдено ни одной витрины интернет-магазина.</span>
        Необходимо создать хотя бы одно поселение (витрину) магазина для правильного формирования адресов страниц товаров в YML-файле для «Яндекс.Маркета».
    </p>
{/if}
</div>

<div class="clear"></div>
{/strip}
<script type="text/javascript">
    if ($.importexport.plugins.yandexmarket) {
        $.importexport.plugins.yandexmarket.init({$params|json_encode});
    } else {

        $.getScript('{$wa_app_static_url}plugins/yandexmarket/js/yandexmarket.js',function(){
            $.importexport.plugins.yandexmarket.init({$params|json_encode});
        });
    }
    {* generic code for plugins with profiles support *}
    $.importexport.profiles.set('yandexmarket',{$profiles|json_encode});
</script>

{foreach $smarty.capture as $name => $template} {if strpos($name,'template-js')}
    <!-- begin {$name} -->
    <script type="text/x-jquery-tmpl" id="{$name}">
{$template|regex_replace:'@(^.*-->)|(<!\-\-.*$)@m':''|replace:'</':'<\/'}
</script>
    <!-- end {$name} -->
{/if} {/foreach}