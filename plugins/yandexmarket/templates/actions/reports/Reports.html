<div class="block double-padded">
    <h1>Интеграция с Яндекс.Маркет</h1>

    <p>Отчет показывает состояния кампаний в Яндекс.Маркет, статус программы «Заказ на Маркете»</p>
    <p><span class="hint">{*
    @TODO описать назначение и смысл экрана
    *}</span>
        {if !empty($error)}
    <p class="errormsg">

        {$error|escape}
        {if !empty($error_code)}
            <span class="hint">
            {if $error_code==403}
                Ошибка авторизации, проверьте корректность настроек
                <a href="?action=plugins#/yandexmarket/" class="inline-link">плагина<i class="icon16 new-window"></i></a>
            {elseif $error_code==420}
                Превышены лимиты на обращения через API
            {/if}
                </span>
        {/if}
    </p>
    {/if}
    {if !empty($graph_data)}

        {* Too easy to shoot yourself in the foot *}
        <div class="hidden block float-right half-padded">
            [`Group by`]:
            <select id="s-yandexmarket-group-by-selector">
                {foreach $group_by_options as $value => $name}
                    <option value="{$value|escape}"{if $group_by == $value} selected{/if}>{$name|escape}</option>
                {/foreach}
            </select>
        </div>

        <div class="graph-wrapper">
            <script>
                (function() {
                    if (typeof showSalesGraph == 'undefined') {
                        return $.ajax({
                            dataType: "script",
                            url: "{$wa_url}wa-apps/shop/js/charts/d3chart-sales.js?{$wa->version()}",
                            cache: true
                        });
                    } else {
                        return $.Deferred(function(d) {
                            d.resolve();
                        });
                    }
                })().done(function() {
                    showSalesGraph({json_encode($graph_data)}, {wa_currency_html(0, $def_cur)|replace:'0':'%s'|json_encode});
                });
            </script>
            <!-- CHART WRAPPERS -->
            <div class="sales-wrapper"></div>
            <div class="hint-wrapper" id="hint-wrapper"></div>
        </div>
    {/if}

    {if !empty($campaigns)}
        <table class="zebra">
            <thead>
            <tr>
                <th>ID</th>
                <th>Домен</th>
                <th>Прайс-листы</th>
                <th>Состояние кампании</th>
                <th>Программа «Заказ на Маркете»</th>
                <th>Точки выдачи заказов</th>
            </tr>
            </thead>
            <tbody>
            {foreach $campaigns as $campaign}
                <tr{if empty($campaign.settlements)} class="grey"{/if}>
                    <td>{$campaign.id|escape}</td>
                    <td>
                        {$campaign.domain|escape}
                        {if !empty($campaign.settlements)}
                            {foreach $campaign.settlements as $settlement}
                                <br/>
                                <span class="hint">{$settlement|escape}</span>
                            {/foreach}
                        {/if}
                    </td>
                    <td>
                        {if !empty($campaign.feeds)}
                            {foreach $campaign.feeds as $feed}
                                {if empty($feed.profile_id)}
                                    <i class="icon16 exclamation"></i>
                                    Профиль для прайс-листа {$feed.id} не найден {$feed.url|escape}. Проверьте настройки плагина или обновите URL прайс-листа.
                                {else}
                                    <a href="?action=importexport#/yandexmarket:{$feed.profile_id}/" target="_blank" class="inline-link"
                                       title="{$feed.id}"><i class="icon16 export"></i>{$feed.profile_info.name|escape}{if !empty($feed.path_mtime)}
                                        <span class="hint">{$feed.path_mtime|wa_datetime:'humandatetime'}</span>
                                        {/if}<i class="icon16 new-window"></i></a>
                                {/if}
                                {if !$feed@last}
                                    <br/>
                                {/if}
                            {/foreach}
                        {/if}
                    </td>
                    <td>
                        {if !empty($campaign.stateIcon)}<i class="icon16 {$campaign.stateIcon|escape}"></i>{/if}
                        {$campaign.stateDescription|escape}
                        {if isset($campaign.offers_count)}
                            <span class="indicator" title="Количество опубликованных предложений">{$campaign.offers_count}</span>
                        {/if}
                        {if !empty($campaign.stateReasons)}
                            <ul class="menu-v with-icons">
                                {foreach $campaign.stateReasons as $description}
                                    <li class="hint">
                                        <i class="icon10 exclamation"></i>{$description|escape}
                                    </li>
                                {/foreach}
                            </ul>
                        {/if}
                        {if !empty($campaign.balance)}
                            <br/>
                            <span class="" title="{$campaign.balance.balance|escape}">
                                {if $campaign.balance.daysLeft<700}<i class="icon16 exclamation"></i>{else}<i class="icon16 yes"></i>{/if}
                                {$campaign.balance.balance_str}
                            </span>
                        {/if}
                    </td>
                    <td>
                        {if !empty($campaign.stateIconCpa)}<i class="icon16 {$campaign.stateIconCpa|escape}"></i>{/if}
                        {$campaign.stateDescriptionCpa|escape}

                        {if isset($campaign.orders_count)}
                            <span class="indicator" title="Количество заказов за последние 30 дней">{$campaign.orders_count}</span>
                        {/if}
                        {if !empty($campaign.stateReasonsCpa)}
                            <ul class="menu-v with-icons">
                                {foreach $campaign.stateReasonsCpa as $description}
                                    <li class="hint"><i class="icon10 exclamation"></i>{$description|escape}</li>
                                {/foreach}
                            </ul>
                        {/if}
                    </td>
                    <td>
                        {if !empty($campaign.outlets)}
                            <ul class="menu-v with-icons">
                                {foreach $campaign.outlets as $outlet}
                                    <li class="hint" title="{"`$outlet.type` `$outlet.id`"|escape}"><i class="icon10 exclamation"></i>{$outlet.name|escape}</li>
                                {/foreach}
                            </ul>
                        {/if}
                    </td>
                </tr>
            {/foreach}
            </tbody>
            <tfoot>
            <tr>
                <th colspan="6">{* @TODO: состояние лимитов API, общие сообщения *}</th>
            </tr>
            </tfoot>
        </table>
    {/if}
</div>


<div class="clear-both"></div>

<div class="hidden">
    <ul class="menu-h">
        <li>
            <select id="s-yandexmarket-report-storefront-selector" class="storefront-selector">
                <option value="">Общие данные</option>
                {foreach $campaigns as $campaign}
                    {if !empty($campaign.settlements)}
                        <optgroup label="{$campaign.domain|escape}" title="{$campaign.id}">
                            {foreach $campaign.settlements as $settlement}
                                <option {if !empty($storefront) && ($storefront==$campaign.id)} selected="selected"{/if} value="{$campaign.id}">{$settlement|escape}</option>
                            {/foreach}
                        </optgroup>
                    {/if}
                {/foreach}
            </select>
        </li>
    </ul>
</div>

<script>
    $(function () {
        "use strict";
        document.title = '{"Яндекс.Маркет"|cat:" — ":{$wa->accountName(false)}|escape:'javascript'}';

        var request_params = {json_encode(ifset($request_options,array()))};
{literal}
        var $storefront_selector = $('#s-yandexmarket-report-storefront-selector').removeAttr('id');
        var action_url = '?plugin=yandexmarket&module=reports';

        // Move selector into the top menu wrapper
        $('#s-reports-custom-controls').empty().append($storefront_selector.closest('ul'));

        // Storefront selector logic

        // Reload page when user changes something in the selector
        $storefront_selector.change(function () {

            $storefront_selector.parent().append('<i class="icon16 loading"></i>');
            $.post(action_url, $.extend({ }, request_params, {storefront: $storefront_selector.val()}), function (r) {

                $('#reportscontent').html(r);
            });
        });

        // Group by period
        var $group_by_selector = $('#s-yandexmarket-group-by-selector');
        $group_by_selector.change(function() {
            $group_by_selector.after('<i class="icon16 loading"></i>');
            $.post(action_url, $.extend({ }, request_params, { group_period: $group_by_selector.val() }), function(r) {
                $('#reportscontent').html(r);
            });
        });

    });
{/literal}
</script>
