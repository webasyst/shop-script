


<div class="block double-padded" id="shop-productprofile" data-product-id="{$product.id}">
    <h1>
        <a href="#/" class="back">&larr; [`Back`]</a>

        <span class="s-product-name">{if $product.id == 'new'}[`New product`]{else}{$product.name|escape}{/if}</span>
        <span class="hint float-right s-product-id" {if $product.id == 'new'}style="display:none;"{/if}>id: {$product.id}</span>

        <!-- plugin hook: 'backend_product.title_suffix' -->
        {* @event backend_product.%plugin_id%.title_suffix *}
        {if !empty($backend_product)}{foreach $backend_product as $_}{ifset($_.title_suffix)}{/foreach}{/if}

        {if $edit_rights}
            <a href="#/product/{$product.id}/edit/" class="button green s-product-edit-link" id="s-edit-product">[`Edit`]</a>
        {/if}

        <!-- plugin hook: 'backend_product.action_button' -->
        {* @event backend_product.%plugin_id%.action_button *}
        {if !empty($backend_product)}{foreach $backend_product as $_}{ifset($_.action_button)}{/foreach}{/if}

    </h1>

    <ul class="menu-h small" id="s-product-frontend-links">
        <li class="s-inline-mixed-string">
            [`Storefront link`]:
            {foreach $frontend_urls as $frontend_url}
                <span class="s-product-frontend-url-not-empty">
                    <a href="{$frontend_url.url}" target="_blank">{$frontend_url.url}</a><i class="icon10 new-window"></i>
                </span>
            {/foreach}
            <span class="s-product-frontend-url-empty gray" {if !empty($frontend_urls)}style="display:none;"{/if}>
                {_w(sprintf('This product is not visible in the storefront because product type “%s” which this product belongs to is not allowed for publishing in any of your storefronts', $product.type.name))}
            </span>
        </li>
    </ul>

{* PRODUCT PROFILE SECTION BEGIN *}
    <div id="s-product-profile-page">
        <div class="sidebar right200px" id="s-toolbar">

            <div class="align-center">
                <ul class="menu-h small">
                    <li class="selected"><a href="#" onclick="return false" class="inline-link"><b><i>[`Last 30 days`]</i></b></a></li>
                    {* <li><a href="#" class="inline-link"><b><i>[`All time`]</i></b></a></li> *}
                </ul>
            </div>

            <div id="product-sales-plot" style="height:150px;margin-bottom:20px;position:relative;left:-8px;width:216px">
                <i class="icon16 loading"></i>
            </div>

            <table class="zebra">
                <tr>
                    <td>[`Sales`]</td>
                    <td>
                        <strong>{shop_currency($sales.total)}</strong>
                    </td>
                </tr>
                {if isset($profit)}
                <tr>
                    <td>[`Profit`]</td>
                    <td>
                        <strong>{shop_currency($profit)}</strong>
                    </td>
                </tr>
                {/if}
            </table>


            {if count($product.skus) > 1}
            <div id="product-sku-plot" style="height:320px;margin-bottom:20px;position:relative;left:-8px;width:216px">
                <i class="icon16 loading"></i>
            </div>
            {/if}
            
            <div id="product-stock-stat" class="s-product-mini-stock-log">
                <br>
                <p class="align-center">
                    [`Total stock balance`]: <strong>{if $product.count !== null}{$product.count}{else}∞{/if}</strong>
                </p>
                {if !empty($runout['product']) && $runout['product'].days < 3*365 && $runout['product'].days > 0}
                    <p>{sprintf(
                        _w('Based on last 30 days sales dynamic (%d items of %s sold during last 30 days), you will run out of %s in <strong>%d days</strong> (on %s)'),
                        $sales.quantity, $product.name, $product.name, $runout['product'].days, wa_date("humandate", $runout['product'].date)
                    )}
                    </p>
                {/if}
            </div>
            {capture name='template-product-stock-stat'}
                <br>
                <p class="align-center">
                    [`Total stock balance`]: <strong>{literal}{% if (o.count !== null) { %}{%#o.count%}{% } else { %}∞{% } %}{/literal}</strong>
                </p>
                {literal}
                {% if (!$.isEmptyObject(o.runout.product_str)) { %}
                    <p>{%#o.runout.product_str%}</p>
                {% } %}
                {/literal}
            {/capture}

            <div id="s-product-delete" class="block align-center">
                <ul class="menu-h with-icons">
                    <li><a href="#/product/{$product.id}/edit/main/product/delete/" class="inline-link js-action"><i class="icon16 delete"></i>[`Delete product`]</a></li>
                </ul>
            </div>

            <!-- plugin hook: 'backend_product.toolbar_section' -->
            {* @event backend_product.%plugin_id%.toolbar_section *}
            {if !empty($backend_product)}{foreach $backend_product as $_}{ifset($_.toolbar_section)}{/foreach}{/if}



        </div>
        <div class="content right200px" id="s-product-view">

            <ul class="s-product-image-crops">
                {capture name='template-product-image-list'}
                    {literal}
                        {% if (!o.type || o.type == 'thumb') { %}
                            {% for (var i = 0, n = o.images.length, image = o.images[0]; i < n; image = o.images[++i]) { %}
                            <li data-image-id="{%#image.id%}">
                                <div class="s-image">
                                    <a href="#/product/{%#o.product_id%}/edit/images/{%#image.id%}/">
                                        <img src="{%#image.url_thumb%}{%# image.edit_datetime_ts ? '?'+image.edit_datetime_ts : '' %}" alt="">
                                    </a>
                                </div>
                                <div class="p-description">
                                    {% if (image.description) { %}
                                        <div class="small editable">{%#image.description%}</div>
                                    {% } else { %}
                                        <div class="small gray editable">{%#o.placeholder%}</div>
                                    {% } %}
                                </div>
                            </li>
                            {% } %}
                        {% } else { %}
                            {% for (var i = 0, n = o.images.length, image = o.images[0]; i < n; image = o.images[++i]) { %}
                                <li data-image-id="{%#image.id%}">{/literal}
                                    {if $edit_rights}
                                        {literal}<a href="#product/{%#o.product_id%}/edit/images/{%#image.id%}/" class="s-product-edit-link">{/literal}
                                    {/if}
                                    {literal}<img src="{%#image.url_crop%}{%# image.edit_datetime_ts ? '?'+image.edit_datetime_ts : '' %}" alt="">{/literal}
                                    {if $edit_rights}
                                        </a>
                                    {/if}
                                {literal}</li>
                            {% } %}
                        {% } %}
                    {/literal}
                {/capture}

                {* @see ProductSkuSettings.html *}

                {capture name='template-sku-image-list'}
                    {literal}
                    {% for (var i = 0, n = o.images.length, image = o.images[0]; i < n; image = o.images[++i]) { %}
                        <li data-image-id="{%#image.id%}" {% if (o.sku.image_id == image.id) { %} class="selected"{% } %}>
                            <a href="#/product/{%#o.sku.product_id%}/edit/main/sku/image/select/{%#o.sku.id%}/{%#image.id%}/" class="js-action">
                                <img src="{%#image.url_crop%}{%# image.edit_datetime_ts ? '?'+image.edit_datetime_ts : '' %}" alt="">
                            </a>
                        </li>
                    {% } %}
                    {/literal}
                {/capture}

                <!-- plugin hook: 'backend_product.image_li' -->
                {* @event backend_product.%plugin_id%.image_li *}
                {if !empty($backend_product)}{foreach $backend_product as $_}{ifset($_.image_li)}{/foreach}{/if}

            </ul>

            <p class="hint"><span class="s-product-summary-input">{$product.summary|escape}</span>
            {if $edit_rights}
            <a href="#/product/{$product.id}/edit/descriptions/" class="s-product-edit-link">[`Edit`]</a></p>
            {/if}

            <table class="zebra s-product-skus">
                <tbody>
                    {foreach $product.skus as $sku_id => $sku}
                    <tr data-id="{$sku_id}" class="{if empty($sku.available)}grey {/if}{if $sku.virtual}s-sku-virtual{/if}" title="{$sku.sku|escape}">
                        <td class="s-name">
                            {$sku.name|escape}
                            <span class="hint">{$sku.sku}</span>
                            {if !empty($sku.file_name)}
                                <i class="icon16 attachment-small"></i>
                            {/if}
                        </td>
                        <td class="s-price">
                            <strong>{if $product.currency !== null}{wa_currency($sku.price, $product.currency)}{else}{wa_currency($sku.price, $primary_currency)}{/if}</strong>
                        </td>
                        <td class="s-stock">
                            {if !count($sku.stock)}
                                {shopHelper::getStockCountIcon($sku.count)}
                                {if $sku.count === null}∞{else}{$sku.count}{/if}
                                {if isset($runout['sku'][$sku_id]) && $runout['sku'][$sku_id]['days'] > 0 && $runout['sku'][$sku_id]['days'] < 90}
                                    <em class="small bold s-stock-warning-low" title="[`Approximate date when you run out of stock for this SKU based on average selling rate for this product`]">{_w('%d day', '%d days', $runout['sku'][$sku_id]['days'])}</em>
                                {/if}
                            {else}
                                {foreach $stocks as $stock_id => $stock}
                                    {if isset($sku.stock[$stock_id])}
                                        {$count = $sku.stock[$stock_id]}
                                    {else}
                                        {$count = null}
                                    {/if}
                                        {shopHelper::getStockCountIcon($count, $stock_id)}

                                        {if $count === null}∞{else}{$count}{/if}
                                        {if isset($runout['sku'][$sku_id]['stock'][$stock_id]) && $runout['sku'][$sku_id]['stock'][$stock_id]['days'] > 0 && $runout['sku'][$sku_id]['stock'][$stock_id]['days'] < 90}
                                            <em class="small bold s-stock-warning-low" title="[`Approximate date when you run out of stock for this SKU based on average selling rate for this product`]">{_w('%d day', '%d days', $runout['sku'][$sku_id]['stock'][$stock_id]['days'])}</em>
                                        {/if}

                                    {if count($stocks) > 1}
                                        <span class="hint">@{$stock.name|escape}</span><br>
                                    {/if}
                                {/foreach}
                            {/if}
                        </td>
                        {if $edit_rights}
                        <td class="min-width">
                            <a href="#/product/{$product.id}/edit/focus=name&sku={$sku_id}" class="nowrap s-product-edit-link"><i class="icon16 edit"></i>[`Edit`]</a>
                        </td>
                        {/if}
                    </tr>
                    {/foreach}

                    {capture name='template-sku'}{literal}
                        {% var sku_id = o.sku_id; %}
                        {% var sku = o.sku; %}
                        {% var stocks = o.stocks || {}; %}
                        {% sku.stocks = sku.stocks || {}; %}
                        {% var stock_ids = o.stock_ids; %}
                        {% var sku_runout = o.runout.sku[sku_id] || {}; %}
                        <tr data-id="{%=sku_id%}" class="{% if(!sku.available) { %}grey {% } %}{% if (sku.virtual == '1') { %}s-sku-virtual{% } %}" title="{%=sku.sku%}">
                            <td class="s-name">
                                {%=sku.name%}
                                <span class="hint">{%=sku.sku%}</span>
                                {% if (sku.file_name) { %}
                                    <i class="icon16 attachment-small"></i>
                                {% } %}
                            </td>
                            <td class="s-price"><strong>{%=sku.price_str%}</strong></td>
                            <td class="s-stock">
                                {% if (!$.isEmptyObject(sku.stock)){ %}
                                    {% for (var i = 0, n = stock_ids.length; i < n; i += 1) { %}
                                        {% var stock_id = stock_ids[i]; %}
                                        {% count = typeof sku.stock[stock_id] !== 'undefined' ? sku.stock[stock_id] : null; %}

                                        {%# sku.stock_icon[stock_id] %}

                                        {% if (count === null) { %}∞{% }else{ %}{%=''+count%}{% } %}
                                        
                                        {% if (sku_runout.stock && (stock_id in sku_runout.stock) && sku_runout.stock[stock_id].days > 0 && sku_runout.stock[stock_id].days < 90) { %}
                                            <em class="small bold s-stock-warning-low">{%#sku_runout.stock[stock_id].days_str%}</em>
                                        {% } %}
                                        
                                        {% if (!$.isEmptyObject(stocks)){ %}
                                            <span class="hint">@{%=stocks[stock_id]['name']%}</span><br>
                                        {% } %}
                                        
                                    {% } %}
                                {% } else { %}
                                    {%# sku.stock_icon[0] %}
                                    {% if (sku.count === null) { %}∞{% }else{ %}{%=''+sku.count%}{% } %}
                                    
                                    {% if (!$.isEmptyObject(sku_runout) && sku_runout.days > 0 && sku_runout.days < 90) { %}
                                        <em class="small bold s-stock-warning-low">{%#sku_runout.days_str%}</em>
                                    {% } %}
                                    
                                {% } %}
                            </td>
                            {/literal}
                            {if $edit_rights}
                            <td class="min-width">
                                <a href="#/product/{$product.id}/edit/focus=name&sku={literal}{%=sku_id%}{/literal}" class="gray s-product-edit-link">[`Edit`]</a>
                            </td>
                            {/if}
                        </tr>
                    {/capture}
                 </tbody>
                </table>

            {if !empty($product.reviews)}
                {$reviews = $product.reviews}
                <div id="s-reviews-block" {if empty($reviews)}style="display: none;"{/if}>
                    <a name="reviews"></a>
                    <h3 class="s-reviews-header">[`Customer reviews`] (<span class="s-reviews-count">{if !empty($counters['reviews'])}{$counters['reviews']}{else}0{/if}</span>)</h3>
                    <div class="s-reviews" id="s-product-profile-reviews">
                        <ul class="menu-v with-icons">
                            {foreach $reviews as $review}
                                <li data-id="{$review.id}" data-parent-id="0">
                                {include file="./include.review.html" inline reply_allowed=true reply_link="#/product/{$product.id}/edit/reviews/{$review.id}/" single_view=true}
                                </li>
                            {/foreach}
                        </ul>
                    </div>
                    <a href="#/product/{$product.id}/edit/reviews/">[`Show all reviews`]</a>
                </div>
            {/if}

        </div>

    </div>
{* PRODUCT PROFILE SECTION END *}

{* PRODUCT EDIT SECTION MENU BEGIN *}
    <ul class="menu-h" id="s-product-edit-menu">
        <li class="main">
            <a href="#/product/{$product.id}/edit/">[`Basics`]
            <span class="s-product-edit-tab-status"></span></a>
        </li>
        <li class="descriptions">
            <a href="#/product/{$product.id}/edit/descriptions/">[`Descriptions`]
            <span class="s-product-edit-tab-status"></span></a>
        </li>
        <li class="features">
            <a href="#/product/{$product.id}/edit/features/">[`Features`]
            <span class="s-product-edit-tab-status"></span></a>
        </li>
        <li class="images">
            <a href="#/product/{$product.id}/edit/images/">[`Images`] <span class="hint">{$counters['images']}</span>
            <span class="s-product-edit-tab-status"></span></a>
        </li>
        <li class="services">
            <a href="#/product/{$product.id}/edit/services/">[`Services`] <span class="hint">{$counters['services']}</span>
            <span class="s-product-edit-tab-status"></span></a>
        </li>
        <li class="related">
            <a href="#/product/{$product.id}/edit/related/">[`Related products`]
            <span class="s-product-edit-tab-status"></span></a>
        </li>
        <li class="pages">
            <a href="#/product/{$product.id}/edit/pages/">[`Pages`] <span class="hint">{$counters['pages']}</span>
            <span class="s-product-edit-tab-status"></span></a>
        </li>
        <li class="reviews">
            <a href="#/product/{$product.id}/edit/reviews/">[`Customer reviews`] <span class="hint">{$counters['reviews']}</span>
            <span class="s-product-edit-tab-status"></span></a>
        </li>
        <li class="stocks-log">
            <a href="#/product/{$product.id}/edit/stockslog/">[`Stock updates`] <span class="hint">{ifset($counters['stocks_log'], 0)}</span>
            <span class="s-product-edit-tab-status"></span></a>            
        </li>

        <!-- plugin hook: 'backend_product.edit_section_li' -->
        {* @event backend_product.%plugin_id%.edit_section_li *}
        {if !empty($backend_product)}{foreach $backend_product as $_}{ifset($_.edit_section_li)}{/foreach}{/if}

    </ul>
{* PRODUCT EDIT SECTION MENU END *}

    <div id="s-product-edit-forms">
        <form action="?module=product&action=save" method="post" id="s-product-save">
        <input type="hidden" name="product[id]" value="{$product.id}">


{* PRODUCT EDIT MAIN TAB SECTION BEGIN *}
        <div class="s-product-form main fields form" style="display: none;">
            <div class="field-group">
                <div class="field">
                    <div class="name">[`Product name`]</div>
                    <div class="value"><input type="text" class="long bold s-product-name-input" value="{$product.name|escape}" name="product[name]"></div>
                </div>
                <div class="field">
                    <div class="name">[`Status`]</div>
                    <div class="value no-shift">
                        <div class="s-product-status">
                            <i class="icon10 {if $product.status}yes{else}no-bw{/if}"></i>
                            <select name="product[status]">
                                <option {if $product.status}selected{/if} value="1">[`Published`]</option>
                                <option {if !$product.status}selected{/if} value="0">[`Hidden`]</option>
                            </select>
                        </div>

                        {foreach $frontend_urls as $frontend_url}
                            {if $frontend_url@first}
                                {* with tricky edit control *}
                                <span class="s-product-frontend-url-not-empty">
                                    {strip}
                                        <span style="display:none" class="s-frontend-base-url">
                                            {$frontend_url.base}
                                        </span>
                                        <a href="{$frontend_url.url}"  class="s-frontend-base-url" target="_blank">
                                            {$frontend_url.base}
                                            <span id="s-product-frontend-url">{$product.url}</span>
                                            <span class="slash">/</span>
                                        </a>
                                        <i class="icon10 new-window"></i>
                                        <input type="text" class="s-product-url-input" id="s-product-frontend-url-input"
                                                                    value="{$product.url|escape}"
                                                                    name="product[url]" style="display:none;"
                                                                >
                                    {/strip}
                                    <a href="javascript:void(0);" class="small inline-link" id="s-product-frontend-url-edit-link">
                                        <i class="icon10 edit"></i><b><i>[`edit`]</i></b>
                                    </a>
                                </span>
                            {else}
                                {* just link *}
                                <span class="s-product-frontend-url-not-empty small">
                                    <a href="{$frontend_url.url}" target="_blank" class="s-product-frontend-url">{$frontend_url.url}</a>
                                    <i class="icon10 new-window"></i>                                    
                                </span>
                            {/if}
                            <br>
                        {/foreach}

                        <p class="s-product-frontend-url-empty hint" {if !empty($frontend_urls)}style="display:none;"{/if}>
                            {_w(sprintf('This product is not visible in the storefront because product type “%s” which this product belongs to is not allowed for publishing in any of your storefronts', $product.type.name))}
                        </p>

                        <p class="s-product-status-text hint" {if $product.status}style="display:none;"{/if}>
                            [`Hidden products are not shown among other products in the storefront, are not available for purchase, and can be viewed by the direct URL only.`]
                        </p>
                    </div>
                </div>
            </div>
            <div class="field-group">
                {if $product_types}
                <div class="field">
                    <div class="name">[`Product type`]</div>
                    <div class="value no-shift" data-type="{$product.type.id|escape}">
                        <span class="js-type-icon">{shopHelper::getIcon($product.type.icon)}</span>
                        <strong class="js-type-name">{$product.type.name|escape}</strong>&nbsp;
                        <a href="#/product/{$product.id}/edit/main/type/select/" class="js-action inline-link"><b><i>[`Change type`]</i></b></a>

                        <select name="product[type_id]" style="display:none;">
                        {if empty($product.type.id)}
                        <option data-icon="{shopHelper::getIcon(null)|escape}" value="" selected="selected" disabled="disabled"></option>
                        {/if}
                        {foreach $product_types as $id=>$type}
                            <option data-icon="{shopHelper::getIcon(ifempty($type.icon,'box'))|escape}" data-sku-type="{$type.sku_type}" value="{$id}"{if $product.type.id == $id} selected="selected"{/if}>
                            {$type.name|escape}
                            </option>
                        {/foreach}
                        </select>
                    </div>
                </div>
                {else}
                <input type="hidden" name="product[type_id]" value="">
                {/if}
                <div class="field">
                    <div class="name">[`Categories`]</div>
                    <div class="value s-product-categories no-shift">
                        {function categories_select category_id=0}
                            <select name="product[categories][]" class="s-product-categories">
                                {if !empty($categories)}
                                    <option value="select" {if !$category_id}selected="selected"{/if}>
                                        [`Please select a category`]
                                    </option>
                                    <option value="create">[`Create new category...`]</option>
                                    <option class="separator" value="---" disabled="disabled">---</option>
                                    {foreach $categories as $category}
                                        <option class="category" value="{$category.id}" {if $category_id == $category.id} selected="selected"{/if}>{"-"|str_repeat:$category.depth}{$category.name|escape}</option>
                                    {/foreach}
                                {else}
                                    <option value="">[`No category exists`]</option>
                                    <option value="create">[`Create new category...`]</option>
                                    <option class="separator" value="---" disabled="disabled" style="display:none;">---</option>
                                {/if}
                            </select>
                            {strip}
                            <a href="#" class="s-product-delete-from-category" title="[`Remove product from this category`]" {if !$category_id}style="display:none;"{/if}>
                                <i class="icon10 delete-bw no-overhanging"></i>
                            </a>
                            {/strip}
                            <span class="s-new-category" style="display:none;">
                                <input type="text" name="new_category" class="new-category" class="js-ignore-change">
                                <input type="hidden" name="product[categories][]" class="val" value="{$category_id}" disabled="disabled">
                                <input type="button" value="[`Create`]">
                            </span>
                            <span class="s-storefront-map">
                                {if isset($storefront_map[$category_id])}
                                    {foreach $storefront_map[$category_id] as $storefront}
                                        <a class="hint" href="{$storefront}" target="_blank">{$storefront}</a>
                                    {/foreach}
                                {/if}
                            </span>
                        {/function}
                        {foreach $product.categories as $category_id => $c}
                            <div>{categories_select category_id=$category_id}</div>
                        {foreachelse}
                            <div>{categories_select}</div>
                        {/foreach}
                        <ul class="menu-v s-category-action">
                            <li><a href="#/product/{$product.id}/edit/main/categories/add/" class="small inline-link js-action"><b><i>[`Add category`]</i></b></a></li>
                        </ul>
                    </div>
                </div>
                {if !empty($taxes)}
                <div class="field">
                    <div class="name">[`Taxable`]</div>
                    <div class="value no-shift">
                        <select name="product[tax_id]">
                        <option value="" {if empty($product.tax_id)} selected="selected"{/if}>[`No`]</option>
                        {foreach $taxes as $tax}
                        <option value="{$tax.id}"{if $product.tax_id == $tax.id} selected="selected"{/if}>{$tax.name|escape}</option>
                        {/foreach}
                        </select>
                    </div>
                </div>
                {/if}
                {* @event backend_product_edit.%plugin_id%.basics *}
                {foreach $backend_product_edit as $_}{if !empty($_.basics)}{$_.basics}{/if}{/foreach}
            </div>

            {capture name="sku_type_field_group"}
                <div class="field-group" id="s-sku-type-field-group">
                    <div class="field">
                        <div class="name">
                            [`Selling mode`]
                        </div>
                        <div class="value no-shift s-sku-type-field-value">
                            <ul class="thumbs li250px">
                                <li>
                                    <label>
                                        <input type="radio"
                                               name="product[sku_type]"
                                               value="{shopProductModel::SKU_TYPE_FLAT}"
                                               {if empty($features) || $product.sku_type == shopProductModel::SKU_TYPE_FLAT}checked{/if}
                                                /> [`Flat SKU list`]
                                        <i class="icon16 ss sku-type-flat"></i>
                                        <br>
                                        <span class="hint"><br>[`Best for single-priced products and products with a flat list of purchase options (SKUs). SKUs are added one-by-one arbitrarly. Customer selects individual SKU and adds it to shopping cart.`]</span>
                                    </label>
                                </li>
                                <li style="width: 400px; margin-left: 50px;">
                                    <label>
                                        <input type="radio"
                                               name="product[sku_type]"
                                               value="{shopProductModel::SKU_TYPE_SELECTABLE}"
                                               {if !empty($features) && $product.sku_type == shopProductModel::SKU_TYPE_SELECTABLE}checked{/if}
                                                {if empty($features)}disabled="disabled"{/if}
                                                /> <span{if empty($features)} class="gray"{/if}>[`Selectable features`]</span>
                                        <i class="icon16 ss sku-type-selectable"></i><br>
                                        <span class="hint">
                                            <br>
                                            [`Best for multi-dimensional featured products, e.g. apparel or footwear which can vary in size and color. Flat SKU list is created automatically based on the combination of features offered for selection. Customer is prompted to choose preferable product feature values which unambiguously identifies SKU that is being added to shopping cart. `]
                                        </span>

                                        <span class="small highlighted" data-sku-type="1" {if !empty($features)} style="display:none;"{/if}>
                                            <br><br>
                                            [`To activate this mode, this particular product must be assigned a product type which offers at least one product feature with a <strong>multiple choice</strong> control, i.e. checkbox list. The list of available product types and features is configured on the <em>Settings &rarr; Product types &amp; features</em> screen.`]<br>
                                        </span>
                                    </label>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

            {/capture}

            {if $product.id == 'new'}
                {$smarty.capture.sku_type_field_group}
            {/if}
            <div class="field-group" id="s-product-feature-superposition-field-group" {if $product.sku_type == shopProductModel::SKU_TYPE_FLAT}style="display:none"{else}data-type="{$product.type_id}"{/if}>
            {include file="./ProductFeaturesSelectable.html"}
            </div>

            <div class="field-group">

                <!-- plugin hook: 'backend_product.edit_basics' -->
                {* @event backend_product.%plugin_id%.edit_basics *}
                {if !empty($backend_product)}{foreach $backend_product as $_}{ifset($_.edit_basics)}{/foreach}{/if}

                <div class="field">
                    <div class="name">
                        [`Pricing & availability`]
                    </div>
                    <div class="value">
                        <table class="zebra s-product-skus">
                            <thead>
                                <tr {if count($product.skus) < 2} style="display:none;"{/if}>
                                    <th class="s-sku-sort min-width"{if count($product.skus) <= 1} style="display:none;"{/if}>&nbsp;</th>
                                    <th>&nbsp;</th>
                                    <th class="s-name"{if count($product.skus) <= 1} style="display:none;"{/if}>[`SKU name`]</th>
                                    <th>[`Price`]</th>
                                    <th>[`In stock`]</th>
                                    <th colspan="2"></th>
                                </tr>
                            </thead>
                            <tfoot>
                            <tr class="white">
                                <td colspan="8" class="alist">
                                    <a href="#/product/{$product.id}/edit/main/sku/add/" class="inline-link js-action add-sku">
                                        <i class="icon16 add"></i><b><i><strong>[`Add purchase option`]</strong></i></b>
                                    </a>
                                </td>
                            </tr>
                            </tfoot>
                            <tbody>
                                {foreach $product.skus as $sku_id => $sku}
                                    <tr data-id="{$sku_id}" class="{if $sku.virtual}s-sku-virtual{/if}">
                                        <td class="s-sku-sort min-width" style="white-space: nowrap;{if $sku@total <= 1}display: none;{/if}">
                                            <i class="icon16 sort"></i>
                                            <input type="radio" name="product[sku_id]" value="{$sku_id}" {if $product.sku_id == $sku.id}checked="checked"{/if}>
                                            <input type="hidden" name="skus[{$sku_id}][available]" value="{intval($sku.available)}">
                                        </td>
                                        <td class="s-sku">
                                            <input type="text" name="skus[{$sku_id}][sku]" value="{$sku.sku|escape}" placeholder="[`SKU code`]" title="[`Any text code or label identifying this product, e.g. model or serial number`]">
                                        </td>
                                        <td class="s-name"{if $sku@total <= 1} style="display: none;"{/if}>
                                            <input type="text" name="skus[{$sku_id}][name]" value="{$sku.name|escape}" class="bold long{if empty($sku.available)} grey{/if}" placeholder="[`SKU name`]" title="[`SKU name displayed in the storefront`]">
                                        </td>
                                        <td class="s-price">
                                            <input type="text" name="skus[{$sku_id}][price]" value="{$sku.price|escape}" class="bold numerical{if empty($sku.available)} grey{/if}" title="[`Price`]">
                                            {if $use_product_currency}
                                                <select class="s-product-currency">
                                                    {foreach $currencies as $code => $currency}
                                                    <option value="{$code}" {if $code == $product.currency}selected="selected"{/if}>{$code}</option>
                                                    {/foreach}
                                                </select>
                                            {else}
                                                {if $product.currency !== null}{$product.currency}{else}{$primary_currency}{/if}
                                            {/if}
                                        </td>
                                        <td class="s-stock">
                                            {if !count($sku.stock)}
                                                <div id="s-product-sku-{$sku_id}">
                                                <span data-stock="0" class="s-product-stock-icon">
                                                {shopHelper::getStockCountIcon($sku.count)}
                                                </span>
                                                <input class="small{if empty($sku.available)} grey{/if}" type="text" name="skus[{$sku_id}][stock][0]"value="{if $sku.count !== null}{$sku.count}{/if}" placeholder="∞" title="[`In stock`]">
                                                {if (count($stocks) >= 1)}
                                                <a href="#/product/{$product.id}/edit/main/sku/stock/{$sku_id}/" class="small inline-link js-action"><b><i>[`Multiple stocks`]</i></b></a>
                                                </div>
                                                {/if}
                                            {/if}
                                            {if count($stocks) >= 1}
                                            <div{if empty($sku.stock)} style="display: none;{/if}" id="s-product-sku-stock-{$sku_id}">
    
                                            {foreach $stocks as $stock_id => $stock}
                                                {if isset($sku.stock[$stock_id])}
                                                    {$count = $sku.stock[$stock_id]}
                                                {else}
                                                    {$count = null}
                                                {/if}
                                                <span data-stock="{$stock_id}" class="s-product-stock-icon">
                                                {shopHelper::getStockCountIcon($count, $stock_id)}
                                                </span>
                                                <input class="small" type="text" name="skus[{$sku_id}][stock][{$stock_id}]"value="{if empty($sku.stock) && $stock@first}{$sku.count}{else}{if $count!==null}{$count}{/if}{/if}" placeholder="∞"{if empty($sku.stock)} disabled="disabled"{/if}>
                                                <span class="hint">@{$stock.name|escape}</span><br>
                                            {/foreach}
                                            </div>
                                            {/if}
    
                                        </td>
                                        <td>
                                              <a href="#/product/{$product.id}/edit/main/sku/settings/{$sku_id}/" class="inline-link nowrap inline-link js-action" title="[`Show all options`]"><i class="icon16 settings"></i><b><i>[`Options`]</i></b></a>
                                        </td>
                                        <td>
                                              <a href="#/product/{$product.id}/edit/main/sku/delete/{$sku_id}/" {if count($product.skus) <= 1}style="display:none;"{/if}
                                                                           class="gray inline-link js-action js-confirm"
                                                                           title="[`Delete this SKU?`]">
                                                  <i class="icon16 delete"></i>
                                              </a>
                                        </td>
                                        <input type="hidden" name="skus[{$sku_id}][virtual]" value="{$sku.virtual}" class="s-input-virtual">
                                    </tr>
                                {/foreach}
    
                                {capture name='template-sku-edit'}{literal}
                                    {% var sku_id = o.sku_id; %}
                                    {% var sku = o.sku; %}
                                    {% var stocks = o.stocks || {}; %}
                                    {% sku.stock = sku.stock || {}; %}
                                    {% var stock_ids = o.stock_ids; %}
                                    <tr data-id="{%=sku_id%}" class="{% if (sku.virtual == '1') { %}s-sku-virtual{% } %}">
                                        <td  class="s-sku-sort min-width" style="white-space: nowrap;">
                                            <i class="icon16 sort"></i>
                                            <input type="radio" name="product[sku_id]" value="{%=sku_id%}" {% if (o.checked) { %}checked="checked"{%}%}>
                                            <input type="hidden" name="skus[{%=sku_id%}][available]" value="{%=sku.available%}">
                                        </td>
                                        <td class="s-sku">
                                            <input type="text" name="skus[{%=sku_id%}][sku]" value="{%=sku.sku%}" class="gray" placeholder="[`SKU code`]">
                                        </td>
                                        <td class="s-name">
                                            <input type="text" name="skus[{%=sku_id%}][name]" value="{%=sku.name%}" class="bold long" placeholder="[`SKU name`]">
                                        </td>
                                        <td class="s-price">
                                            <input type="text" name="skus[{%=sku_id%}][price]" value="{%=sku.price_loc%}" class="bold numerical">
                                            {/literal}
                                            {if $use_product_currency}
                                                <select class="s-product-currency">
                                                    {foreach $currencies as $code => $currency}
                                                        <option value="{$code}" {if $code == $product.currency}selected="selected"{/if}>{$code}</option>
                                                    {/foreach}
                                                </select>
                                            {else}
                                                {if $product.currency !== null}{$product.currency}{else}{$primary_currency}{/if}
                                            {/if}
                                            {literal}
                                        </td>
                                        <td class="s-stock">
                                            {% if ($.isEmptyObject(sku.stock)) { %}
                                                <div id="s-product-sku-{%=sku_id%}">
                                                <span data-stock="0" class="s-product-stock-icon">
                                                {%# sku.stock_icon[0] %}
                                                </span>
                                                <input class="small" type="text" name="skus[{%=sku_id%}][stock][0]"value="{% if(sku.count !== null) { %}{%=''+sku.count%}{% } %}" placeholder="∞">
                                                {% if(!$.isEmptyObject(stocks)) { %}
                                                <a href="#/product/{/literal}{$product.id}{literal}/edit/main/sku/stock/{%=sku_id%}/" class="small inline-link js-action"><b><i>[`Multiple stocks`]</i></b></a>
                                                </div>
                                                {% } %}
                                            {% } %}
    
                                            {% if(!$.isEmptyObject(stocks)) { %}
                                            <div{% if($.isEmptyObject(sku.stock)) { %} style="display: none;{% } %}" id="s-product-sku-stock-{%=sku_id%}">
                                            
                                            {% for (var i = 0, n = stock_ids.length; i < n; i += 1) { %}
                                                {% var stock_id = stock_ids[i]; %}
                                                {% if(typeof(sku.stock[stock_id]) != 'undefined') { %}
                                                    {% count = sku.stock[stock_id]; %}
                                                {% } else { %}
                                                    {% count = null; %}
                                                {% } %}
                                                <span data-stock="{%=stock_id%}" class="s-product-stock-icon">
                                                {%# sku.stock_icon[stock_id]?sku.stock_icon[stock_id]:sku.stock_icon[0] %}
                                                </span>
                                                <input class="small" type="text" name="skus[{%=sku_id%}][stock][{%=stock_id%}]"
                                                value="{% if (count !== null) { %}{%=''+count%}{% } %}" placeholder="∞" {% if($.isEmptyObject(sku.stock)) { %} disabled="disabled"{% } %}>
                                                {% if(!$.isEmptyObject(stocks)) { %}
                                                <span class="hint">@{%=stocks[stock_id]['name']%}</span><br>
                                                {% } %}
    
                                            {% } %}
                                            </div>
                                            {% } %}
    
                                        </td>
    
                                        <td>
                                              <a href="#/product/{/literal}{$product.id}{literal}/edit/main/sku/settings/{%=sku_id%}/" class="inline-link nowrap js-action" title="[`Show all options`]"><i class="icon16 settings"></i><b><i>[`Options`]</i></b></a>
                                        </td>
                                        <td>
                                              <a href="#/product/{/literal}{$product.id}{literal}/edit/main/sku/delete/{%=sku_id%}/" 
                                                                           class="inline-link js-action js-confirm"
                                                                           title="[`Delete this SKU?`]">
                                                  <i class="icon16 delete"></i>
                                              </a>
                                        </td>
                                        <input type="hidden" name="skus[{%=sku_id%}][virtual]" value="{%=sku.virtual%}" class="s-input-virtual">
                                    </tr>
                                {/literal}{/capture}
    
                                {capture name='template-sku-settings'}{literal}
                                    {% var sku_id = o.sku_id; %}
                                    {% var sku = o.sku; %}
                                    <tr data-id="{%=sku_id%}" class="js-sku-settings">
    
                                        <td colspan="7">
                                        [`loading...`]<i class="icon16 loading"></i>
                                        </td>
                                    </tr>
                                {/literal}{/capture}
                            </tbody>
                        </table>
                    </div>
                    <input type="hidden" value="{$product.currency}" name="product[currency]" id="s-product-currency-code">
                </div>
            </div>
            {if $product.id != 'new'}
                {$smarty.capture.sku_type_field_group}
            {/if}
        </div>
{* PRODUCT EDIT MAIN TAB SECTION END *}


{* PRODUCT EDIT DESCRIPTIONS TAB SECTION BEGIN *}
        <div class="s-product-form descriptions" style="display: none;">
            <div class="fields form">
              <div class="field-group">
                <div class="field">
                    <div class="name">[`Summary`]</div>
                    <div class="value"><textarea name="product[summary]" style="height: 37px;">{$product.summary|escape}</textarea>
                        <br /><span class="hint">[`Few words describing the most of the product.`]</span>
                    </div>
                </div>
                <div class="field">
                    <div class="name">[`Tags`]</div>
                    <div class="value">
                        <input id="product-tags" value="{implode(',', $product.tags)}" name="product[tags]">
                        <span class="hint">[`Separate tags with comma (,).`]</span>
                        
                        <div id="s-product-popular-tags" class="tags small">
                            {if $popular_tags}
                                [`Popular tags`]:
                                {foreach $popular_tags as $tag}
                                    <span><a data-tag-id="{$tag.id}" href="javascript:void(0);" class="inline-link"><b><i>{$tag.name|escape}</i></b></a></span>
                                {/foreach}
                                <br>
                            {/if}
                        </div>
                        
                    </div>
                </div>

                <!-- plugin hook: 'backend_product.edit_descriptions' -->
                {* @event backend_product.%plugin_id%.edit_descriptions *}
                {if !empty($backend_product)}{foreach $backend_product as $_}{ifset($_.edit_descriptions)}{/foreach}{/if}

              </div>
              <div class="field-group">
                <div class="field">
                    <div class="name">[`Title`] <span class="hint">&lt;title&gt;</span></div>
                    <div class="value">
                        <input value="{$product.meta_title|escape}" 
                                            id="s-product-meta-title"
                                            name="product[meta_title]" 
                                            placeholder="{$product.name|escape}" class="long bold"
                                      >
                    </div>
                </div>
                <div class="field">
                    <div class="name">[`META Keywords`]</div>
                    <div class="value">
                        <textarea name="product[meta_keywords]">{$product.meta_keywords|escape}</textarea>
                    </div>
                </div>
                <div class="field">
                    <div class="name">[`META Description`]</div>
                    <div class="value">
                        <textarea name="product[meta_description]">{$product.meta_description|escape}</textarea>
                        <br>
                        <span class="hint">{sprintf('[`Variables <strong>%s</strong> will be replaced with the actual product information when displaying it on the storefront. Can be used in title and META fields.`]','&#123;$name&#125;, &#123;$summary&#125;, &#123;$price&#125;')}</span>
                    </div>
                </div>
              </div>
              <div class="field-group">
                <div class="field description">
                    <div class="name">[`Description`]</div>
                    <div class="value" id="s-product-description">
                        <div class="wa-editor-core-wrapper s-editor-core-wrapper">
                            <ul class="wa-editor-wysiwyg-html-toggle s-wysiwyg-html-toggle">
                                <li class="selected"><a class="wysiwyg" href="#">[s`WYSIWYG`]</a></li>
                                <li><a class="html" href="#">HTML</a></li>
                            </ul>
                            <div>
                                <textarea id="s-product-description-content" name="product[description]">{$product.description|escape}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
              </div>

                <div class="field-group">
                    <div class="field">
                        <div class="name">
                            <label for="custom-settings">
                            [`Custom parameters`]
                            </label>
                        </div>
                        <div class="value">
                            <textarea name="product[params]" rows="10" cols="5">{if $product->params}{foreach $product->params as $k=>$v}{if $k!='order'}{$k}={$v|escape|cat:"\n"}{/if}{/foreach}{/if}</textarea><br>
                            <span class="hint">[`Optional set of custom <em>key=value</em> parameters which can be used within a frontend's theme template as <em>&#123;$product.params.key&#125;</em>. Each key=value pair should be on a separate line.`]</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>
{* PRODUCT EDIT DESCRIPTIONS TAB SECTION END *}

        {capture name="template-productprofile-tab"}{literal}
        <div class="s-product-form {%#o.id%}">
            <i class="icon16 loading"></i>[`Loading`]
        </div>{/literal}{/capture}


        <div id="s-product-edit-save-panel">
            <div class="block bordered-top">
                <input type="submit" class="button green" value="[`Save`]" id="s-product-save-button">
                <em class="hint">Ctrl + S</em>
                <span id="product-save-message" class="s-product-save-message"><!-- message placeholder --></span>
            </div>
        </div>
        </form>
    </div>

</div>

{* js templates block*}
{foreach $smarty.capture as $template => $template_content}
{if $template_content && (strpos($template, 'template-')===0)}
<script id="{$template}" type="text/html">
{$template_content|replace:'</':'<\/'}
</script>{capture name=$template}{/capture}
{/if}
{/foreach}

{$title_suffix = " — "|cat:{$wa->accountName(false)}|escape:'javascript'}

<script type="text/javascript">
    var wa_url = '{$wa_url}';
    var wa_app = 'shop';
    var wa_lang = '{$lang}';


    $(function() {
    
        $('#s-product-description-content').data('uploadFields', {
            '_csrf': "{waRequest::cookie('_csrf', '')}"
        });
    
        $.product.setData('main','stocks',{$stocks|json_encode});
        $.product.setData('main','stock_ids', {array_keys($stocks)|json_encode})
        {if !empty($product.reviews)}
        $.product_reviews.init({
            container: '#s-reviews-block',
            reply: 'ignore',
            statuses: {
                deleted:  '{shopProductReviewsModel::STATUS_DELETED}',
                published:'{shopProductReviewsModel::STATUS_PUBLISHED}'
            }
        });
        {/if}
    });
    {if !empty($product.reviews)}
        $('#s-all-reviews').find('.count-new:first').text({if $sidebar_counters.reviews.new}'+{$sidebar_counters.reviews.new}'{else}''{/if});
    {/if}
    {if $product.id > 0}
        $.product_images.init({
            product_id: {$product.id},
            images: {json_encode(array_values($product.images))},
            type: 'crop',
            image_list: '#s-product-view .s-product-image-crops'
        });
    {/if}

    // Sales report plot
    var sales_plot_data = {if empty($sales_plot_data)}[]{else}{json_encode($sales_plot_data)}{/if};
 // "By SKU" pie graph
    var sku_plot_data = {if empty($sku_plot_data)}[]{else}{json_encode($sku_plot_data)}{/if};
    $.product.setOptions({
        title_suffix: '{$title_suffix}',
        edit_rights:    {if $edit_rights}true{else}false{/if},
        sidebar_width: {if $sidebar_width}{$sidebar_width}{else}0{/if},
        sales_rate: {str_replace(',', '.', $sales_rate)}
    });

    {if $product.id > 0}
        document.title = '{$product.name|escape|cat:$title_suffix}';
    {else}
        document.title = '[`New product`]{$title_suffix}';
    {/if}

</script>
